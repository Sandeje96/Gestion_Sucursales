{# app/templates/daily_records/index.html #}
{% extends "layout/base.html" %}

{% block title %}
    Registros y Bandejas - {{ current_user.branch_name if not current_user.is_admin_user() else 'Sistema' }}
{% endblock %}

{% block extra_css %}
<style>

    .branch-tray-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

    .branch-tray-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .cash-tray-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

    .cash-tray-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .tray-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .tray-icon.efectivo {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .tray-icon.mercadopago {
        background-color: rgba(0, 123, 255, 0.1);
        color: #007bff;
    }

    .tray-icon.debito {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    .tray-icon.credito {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .tray-icon.total {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }

    .tray-amount {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .text-purple {
        color: #6f42c1 !important;
    }

    .alert-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }

    .filters-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .btn-empty {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .btn-empty:hover {
        background-color: #c82333;
        border-color: #bd2130;
        color: white;
    }

    /* Loading overlay */
    #dashboardLoadingOverlay {
        backdrop-filter: blur(2px);
    }

    /* Tabla responsiva mejorada */
    .table-responsive {
        border-radius: 0.375rem;
    }

    /* Estados de registros */
    .table-secondary {
        opacity: 0.7;
    }

    /* Indicador de filtros */
    #filtersIndicator {
        border-left: 4px solid #0dcaf0;
        background-color: #f8f9fa;
    }

    /* Animaciones suaves */
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .branch-tray-card {
            margin-bottom: 1rem;
        }
        
        .cash-tray-card {
            margin-bottom: 1rem;
        }
        
        .tray-amount {
            font-size: 1.25rem;
        }
    }

    /* Estado de error en tarjetas */
    .cash-tray-card .tray-amount:contains("Error") {
        color: #dc3545 !important;
        font-size: 1rem;
    }

    .filters-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.25rem;
    }

    .alert-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }

    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
    }

    .btn-outline-info.btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .form-text {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .invalid-feedback.d-block {
        display: block !important;
    }

    .mb-1 {
        margin-bottom: .25rem !important;
        color: black;
    }

    .mb-3 {
        margin-bottom: 1rem !important;
        color: black;
    }

    .card-body.tt.text-center {
        background: cornflowerblue;
    }
    .cash-tray-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,249,250,0.95) 100%);
        border-left: 5px solid;
    }

    .cash-tray-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .cash-tray-card.efectivo { border-left-color: #10b981; }
    .cash-tray-card.mercadopago { border-left-color: #3b82f6; }
    .cash-tray-card.debito { border-left-color: #f59e0b; }
    .cash-tray-card.credito { border-left-color: #ef4444; }
    .cash-tray-card.total { border-left-color: #8b5cf6; }

    .tray-amount {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .tray-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .tray-icon.efectivo { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .tray-icon.mercadopago { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .tray-icon.debito { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .tray-icon.credito { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .tray-icon.total { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }

    .branch-tray-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }

    .branch-tray-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-color: #0d6efd;
    }

    .btn-empty {
        background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
        border: none;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-empty:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        color: white;
    }

    .btn-empty-record {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        border: none;
        color: #000;
        font-weight: 600;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .btn-empty-record:hover {
        color: #000;
        transform: scale(1.05);
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .records-section {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .filters-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-cash-register text-primary me-2"></i>
                        Bandejas de Efectivo y Registros
                        {% if not current_user.is_admin_user() %}
                            - {{ current_user.branch_name }}
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        Controla el efectivo acumulado y gestiona los registros diarios
                    </p>
                </div>
                
                <div class="d-flex gap-2">
                    {% if not current_user.is_admin_user() %}
                        <a href="{{ url_for('daily_records.create') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nuevo Registro
                        </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-info" onclick="refreshTrays()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de bandejas totales -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="fas fa-wallet me-2 text-success"></i>
                Dinero Disponible en Bandejas
                <small class="text-muted">(Total acumulado por m√©todo de pago)</small>
            </h4>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card cash-tray-card efectivo">
                <div class="card-body text-center">
                    <div class="tray-icon efectivo mx-auto">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h6 class="card-title text-muted mb-2">Efectivo</h6>
                    <div class="tray-amount text-success" id="totalCashTray">$0,00</div>
                    <small class="text-muted">En todas las sucursales</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card cash-tray-card mercadopago">
                <div class="card-body text-center">
                    <div class="tray-icon mercadopago mx-auto">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <h6 class="card-title text-muted mb-2">MercadoPago</h6>
                    <div class="tray-amount text-primary" id="totalMercadoPagoTray">$0,00</div>
                    <small class="text-muted">En todas las sucursales</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card cash-tray-card debito">
                <div class="card-body text-center">
                    <div class="tray-icon debito mx-auto">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h6 class="card-title text-muted mb-2">D√©bito</h6>
                    <div class="tray-amount text-warning" id="totalDebitoTray">$0,00</div>
                    <small class="text-muted">En todas las sucursales</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card cash-tray-card credito">
                <div class="card-body text-center">
                    <div class="tray-icon credito mx-auto">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h6 class="card-title text-muted mb-2">Cr√©dito</h6>
                    <div class="tray-amount text-danger" id="totalCreditoTray">$0,00</div>
                    <small class="text-muted">En todas las sucursales</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card cash-tray-card total">
                <div class="card-body text-center">
                    <div class="tray-icon total mx-auto">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <h6 class="card-title text-muted mb-2">Total General</h6>
                    <div class="tray-amount text-purple" id="totalGeneralTray">$0,00</div>
                    <small class="text-muted">Suma de todos los m√©todos</small>
                </div>
            </div>
        </div>
        
        {% if current_user.is_admin_user() %}
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card cash-tray-card bg-danger text-white">
                <div class="card-body tt text-center">
                    <div class="tray-icon bg-white bg-opacity-20 mx-auto">
                        <i class="fas fa-broom text-white"></i>
                    </div>
                    <h6 class="card-title mb-3">Acciones</h6>
                    <button class="btn btn-light btn-sm w-100 mb-2" onclick="emptyAllTrays()">
                        <i class="fas fa-trash me-1"></i>Vaciar Todo
                    </button>
                    <button class="btn btn-outline-light btn-sm w-100" onclick="recalculateTrays()">
                        <i class="fas fa-sync me-1"></i>Recalcular
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <!-- Bandejas por sucursal -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="fas fa-store me-2 text-info"></i>
                Bandejas por Sucursal
            </h4>
        </div>
        
        <div class="col-12">
            <div id="branchTraysContainer">
                <!-- Se carga din√°micamente con JavaScript -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando bandejas...</span>
                    </div>
                    <p class="text-muted mt-2">Cargando informaci√≥n de bandejas...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de b√∫squeda -->
    <div class="row mb-4">
    <div class="col-12">
        <div class="filters-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filtros de Registros
                </h6>
                {% if request.args %}
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Limpiar Filtros
                </button>
                {% endif %}
            </div>
            
            <!-- Mensaje de filtros aplicados -->
            {% if filters_applied %}
            <div class="alert alert-info alert-sm mb-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Filtros aplicados:</strong> {{ ', '.join(filters_applied) }}
            </div>
            {% endif %}
            
            <form method="GET" class="row g-3" id="filtersForm" novalidate>
                <div class="col-md-3">
                    {{ filter_form.start_date.label(class="form-label fw-semibold") }}
                    <div class="input-group">
                        {{ filter_form.start_date(
                            class="form-control",
                            placeholder="dd/mm/yyyy",
                            autocomplete="off"
                        ) }}
                        <span class="input-group-text">
                            <i class="fas fa-calendar"></i>
                        </span>
                    </div>
                    {% if filter_form.start_date.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in filter_form.start_date.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>Fecha desde la cual buscar
                    </div>
                </div>
                
                <div class="col-md-3">
                    {{ filter_form.end_date.label(class="form-label fw-semibold") }}
                    <div class="input-group">
                        {{ filter_form.end_date(
                            class="form-control",
                            placeholder="dd/mm/yyyy",
                            autocomplete="off"
                        ) }}
                        <span class="input-group-text">
                            <i class="fas fa-calendar"></i>
                        </span>
                    </div>
                    {% if filter_form.end_date.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in filter_form.end_date.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>Fecha hasta la cual buscar
                    </div>
                </div>
                
                {% if current_user.is_admin_user() %}
                <div class="col-md-3">
                    {{ filter_form.branch_filter.label(class="form-label fw-semibold") }}
                    {{ filter_form.branch_filter(
                        class="form-select",
                        onchange="this.form.requestSubmit()"
                    ) }}
                    {% if filter_form.branch_filter.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in filter_form.branch_filter.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>Filtrar por sucursal espec√≠fica
                    </div>
                </div>
                {% endif %}
                
                <div class="col-md-3 d-flex align-items-end">
                    <div class="d-grid gap-2 d-md-flex w-100">
                        <button type="submit" class="btn btn-primary flex-fill" id="filterSubmitBtn">
                            <i class="fas fa-search me-2"></i>Filtrar
                        </button>
                        <a href="{{ url_for('daily_records.index') }}" class="btn btn-outline-secondary" title="Limpiar filtros">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Filtros r√°pidos adicionales -->
                <div class="col-12">
                    <div class="border-top pt-3 mt-2">
                        <small class="text-muted fw-semibold">Filtros R√°pidos:</small>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="setQuickFilter('today')">
                                <i class="fas fa-clock me-1"></i>Hoy
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="setQuickFilter('yesterday')">
                                <i class="fas fa-calendar-minus me-1"></i>Ayer
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="setQuickFilter('week')">
                                <i class="fas fa-calendar-week me-1"></i>Esta Semana
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="setQuickFilter('month')">
                                <i class="fas fa-calendar-alt me-1"></i>Este Mes
                            </button>
                            {% if current_user.is_admin_user() %}
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="setQuickFilter('unverified')">
                                <i class="fas fa-exclamation-triangle me-1"></i>Sin Verificar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Tabla de registros -->
    <div class="row">
        <div class="col-12">
            <div class="records-section">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Lista de Registros 
                        <span id="recordsCountBadge" class="badge bg-primary ms-2">Cargando...</span>
                    </h6>
                    
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i>Exportar
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.export_csv', **request.args) }}">
                                    <i class="fas fa-file-csv me-2"></i>Exportar CSV
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="recordsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    {% if current_user.is_admin_user() %}
                                    <th>Sucursal</th>
                                    {% endif %}
                                    <th>Ventas Totales</th>
                                    <th>Efectivo</th>
                                    <th>MercadoPago</th>
                                    <th>D√©bito</th>
                                    <th>Cr√©dito</th>
                                    <th>Gastos</th>
                                    <th>Ganancia</th>
                                    <th>Estado</th>
                                    <th width="150">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se actualiza din√°micamente con JavaScript -->
                                <tr>
                                    <td colspan="{% if current_user.is_admin_user() %}11{% else %}10{% endif %}" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando registros...</span>
                                        </div>
                                        <div class="mt-2 text-muted">Cargando registros...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Procesando...</span>
        </div>
        <h5 class="text-white">Procesando...</h5>
        <p class="text-light">Por favor espera un momento</p>
    </div>
</div>

<!-- Modales de confirmaci√≥n para eliminar -->
{% for record in records.items %}
{% if current_user.can_edit_record(record) %}
<div class="modal fade" id="deleteModal{{ record.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas eliminar el registro del <strong>{{ record.record_date.strftime('%d/%m/%Y') }}</strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Esta acci√≥n no se puede deshacer y tambi√©n afectar√° las bandejas de efectivo.</strong>
                </div>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Ventas totales:</small>
                        <div><strong>${{ "{:,.2f}".format(record.total_sales).replace(",", "X").replace(".", ",").replace("X", ".") }}</strong></div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Gastos:</small>
                        <div><strong>${{ "{:,.2f}".format(record.total_expenses).replace(",", "X").replace(".", ",").replace("X", ".") }}</strong></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <form method="POST" action="{{ url_for('daily_records.delete', id=record.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Eliminar Registro
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
// Variables globales optimizadas
let isLoading = false;
let filterTimeout = null;
let loadingTimeout = null;
let currentFilters = {
    start_date: null,
    end_date: null,
    branch_filter: null
};
let currentDashboardData = null;

// Funci√≥n principal de inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã Inicializando dashboard integrado...');
    
    // ‚úÖ EXTRAER FILTROS DE LA URL
    extractFiltersFromURL();
    
    
    
    // ‚úÖ CARGAR DASHBOARD INICIAL
    loadIntegratedDashboard();
});

// Funci√≥n para extraer filtros de la URL
function extractFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    currentFilters.start_date = urlParams.get('start_date');
    currentFilters.end_date = urlParams.get('end_date');
    currentFilters.branch_filter = urlParams.get('branch_filter');
    
    console.log('üîç Filtros extra√≠dos de URL:', currentFilters);
}

// Funci√≥n principal para cargar todo el dashboard
const originalLoadIntegratedDashboard = loadIntegratedDashboard;
loadIntegratedDashboard = async function() {
    try {
        console.log('üìä Cargando dashboard integrado...');
        showDashboardLoading();
        
        // Construir URL con par√°metros de filtro
        const params = new URLSearchParams();
        if (currentFilters.start_date) params.append('start_date', currentFilters.start_date);
        if (currentFilters.end_date) params.append('end_date', currentFilters.end_date);
        if (currentFilters.branch_filter) params.append('branch_filter', currentFilters.branch_filter);
        
        const url = `{{ url_for('daily_records.api_integrated_dashboard') }}?${params.toString()}`;
        console.log('üåê Llamando a:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Datos recibidos:', data);
        
        if (data.status === 'success') {
            currentDashboardData = data.data;
            
            // ‚úÖ VALIDAR DATOS ANTES DE MOSTRAR
            validateFilterData(data.data);
            
            // Actualizar todas las secciones
            updateDineroDisponibleCards(data.data.totals);
            updateBranchTraysSection(data.data.branch_trays);
            updateRecordsTable(data.data.records);
            updateFilterIndicators(data.filters_applied);
            
            console.log('‚úÖ Dashboard actualizado correctamente');
        } else {
            throw new Error(data.message || 'Error en la respuesta');
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando dashboard:', error);
        showDashboardError(error.message);
    } finally {
        hideDashboardLoading();
    }
};

// Actualizar tarjetas de "Dinero Disponible"
function updateDineroDisponibleCards(totals) {
    console.log('üí∞ [OPTIMIZED] Actualizando tarjetas r√°pidamente...');
    
    // Batch DOM updates para mejor performance
    const updates = [
        { id: 'totalCashTray', value: totals.cash },
        { id: 'totalMercadoPagoTray', value: totals.mercadopago },
        { id: 'totalDebitoTray', value: totals.debit },
        { id: 'totalCreditoTray', value: totals.credit },
        { id: 'totalGeneralTray', value: totals.total }
    ];
    
    // Actualizar todos los elementos de una vez
    updates.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = '$' + formatCurrencyArgentino(value);
        }
    });
    
    // Actualizar descripci√≥n
    updateCardDescriptions();
    
    console.log(`üí∞ Totales actualizados: Cash $${formatCurrencyArgentino(totals.cash)}, Total $${formatCurrencyArgentino(totals.total)}`);
}


window.debugFilterData = function() {
    console.log('üîç DEBUG - Estado actual de filtros:');
    console.log('Filtros actuales:', currentFilters);
    console.log('Tipo de filtro:', getFilterType());
    console.log('¬øEst√° filtrado?:', isFiltered());
    
    if (currentDashboardData) {
        console.log('Datos del dashboard:', currentDashboardData);
        console.log('Totales:', currentDashboardData.totals);
        console.log('Sucursales:', currentDashboardData.branch_trays?.map(t => t.branch_name));
    }
    
    // Verificar URL actual
    console.log('URL actual:', window.location.href);
    console.log('Par√°metros URL:', new URLSearchParams(window.location.search));
};

function validateFilterData(data) {
    const filterType = getFilterType();
    
    console.log('üîç Validando coherencia de datos...');
    console.log('Tipo de filtro:', filterType);
    
    if (filterType === 'branch_only') {
        // Si solo filtramos por sucursal, verificar que los totales correspondan
        const expectedBranch = currentFilters.branch_filter;
        const branchData = data.branch_trays?.find(t => t.branch_name === expectedBranch);
        
        if (branchData) {
            const calculatedTotal = 
                branchData.accumulated_cash + 
                branchData.accumulated_mercadopago + 
                branchData.accumulated_debit + 
                branchData.accumulated_credit;
                
            console.log(`‚úÖ Sucursal ${expectedBranch}:`);
            console.log(`   Total calculado: $${formatCurrencyArgentino(calculatedTotal)}`);
            console.log(`   Total en datos: $${formatCurrencyArgentino(data.totals.total)}`);
            
            if (Math.abs(calculatedTotal - data.totals.total) > 0.01) {
                console.warn('‚ö†Ô∏è Inconsistencia detectada en totales!');
            }
        }
    }
    
    if (filterType === 'date_only') {
        console.log(`‚úÖ Filtro por fecha:`);
        console.log(`   Desde: ${currentFilters.start_date || 'N/A'}`);
        console.log(`   Hasta: ${currentFilters.end_date || 'N/A'}`);
        console.log(`   Total per√≠odo: $${formatCurrencyArgentino(data.totals.total)}`);
    }
}

// Actualizar secci√≥n de bandejas por sucursal
function updateBranchTraysSection(branchTrays) {
    console.log('üè™ Actualizando bandejas por sucursal:', branchTrays);
    
    const container = document.getElementById('branchTraysContainer');
    
    if (!branchTrays || branchTrays.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay datos de bandejas</h5>
                <p class="text-muted">
                    ${isFiltered() ? 
                        'No se encontraron datos para los filtros aplicados' : 
                        'Las bandejas se crear√°n autom√°ticamente cuando se carguen registros'
                    }
                </p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    branchTrays.forEach(tray => {
        const isFiltered = currentFilters.start_date || currentFilters.end_date;
        
        html += `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card branch-tray-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-store me-2"></i>
                            ${tray.branch_name}
                        </h6>
                        <span class="badge bg-primary">
                            ${isFiltered ? 'Per√≠odo' : 'Acumulado'}
                        </span>
                    </div>
                    <div class="card-body">
                        
                        <hr class="my-3">
                        
                        <!-- Total acumulado en efectivo -->
                        <div class="text-center mb-3">
                            <small class="text-muted">Total Acumulado en Efectivo:</small>
                            <div class="h4 text-warning mb-0">
                                $${formatCurrencyArgentino(tray.accumulated_cash)}
                            </div>
                        </div>
                        
                        <!-- Desglose de otros m√©todos -->
                        <div class="row text-center small">
                            <div class="col-4">
                                <div class="text-muted">MP</div>
                                <div>$${formatCurrencyArgentino(tray.accumulated_mercadopago)}</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted">D√©bito</div>
                                <div>$${formatCurrencyArgentino(tray.accumulated_debit)}</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted">Cr√©dito</div>
                                <div>$${formatCurrencyArgentino(tray.accumulated_credit)}</div>
                            </div>
                        </div>
                        
                        <hr class="my-3">
                        
                        <!-- Acciones -->
                        ${!isFiltered && tray.can_empty ? `
                            ${tray.total_accumulated > 0 ? `
                                <button class="btn btn-outline-danger btn-sm w-100" 
                                        onclick="emptyBranchTray('${tray.branch_name}')">
                                    <i class="fas fa-hand-holding-usd me-2"></i>
                                    Vaciar Bandeja ($${formatCurrencyArgentino(tray.total_accumulated)})
                                </button>
                            ` : `
                                <div class="text-center text-muted">
                                    <i class="fas fa-check-circle me-1"></i>Bandeja vac√≠a
                                </div>
                            `}
                        ` : `
                            <div class="text-center text-muted small">
                                ${isFiltered ? 
                                    '<i class="fas fa-filter me-1"></i>Vista filtrada' : 
                                    '<i class="fas fa-lock me-1"></i>Sin permisos'
                                }
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Actualizar tabla de registros
function updateRecordsTable(records) {
    console.log(`üìã [OPTIMIZED] Actualizando tabla: ${records?.length || 0} registros`);
    
    const tableBody = document.querySelector('#recordsTable tbody');
    if (!tableBody) return;
    
    if (!records || records.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i><br>
                    ${isFiltered() ? 
                        'No se encontraron registros para los filtros aplicados' : 
                        'No hay registros para mostrar'
                    }
                </td>
            </tr>
        `;
        return;
    }
    
    // ‚úÖ CORRECCI√ìN: Detectar columna de sucursal correctamente
    const hasBranchColumn = Array.from(document.querySelectorAll('#recordsTable th'))
        .some(th => th.textContent.trim() === 'Sucursal');
    
    console.log('üîç ¬øTiene columna de sucursal?', hasBranchColumn);
    
    // ‚úÖ RENDERIZADO OPTIMIZADO: Crear HTML directamente
    let html = '';
    
    records.forEach(record => {
        const netClass = record.net_profit >= 0 ? 'text-success' : 'text-danger';
        const statusBadge = record.is_withdrawn ? 
            '<span class="badge bg-secondary"><i class="fas fa-check-circle me-1"></i>Retirado</span>' : 
            '<span class="badge bg-light text-muted">Disponible</span>';
        
        html += `
            <tr ${record.is_withdrawn ? 'class="table-secondary"' : ''}>
                <td><strong>${record.date}</strong></td>
                ${hasBranchColumn ? `<td><span class="badge bg-info">${record.branch_name}</span></td>` : ''}
                <td class="text-success fw-bold">$${formatCurrencyArgentino(record.total_sales)}</td>
                <td>$${formatCurrencyArgentino(record.cash_sales)}</td>
                <td>$${formatCurrencyArgentino(record.mercadopago_sales)}</td>
                <td>$${formatCurrencyArgentino(record.debit_sales)}</td>
                <td>$${formatCurrencyArgentino(record.credit_sales)}</td>
                <td class="text-danger">$${formatCurrencyArgentino(record.total_expenses)}</td>
                <td class="${netClass} fw-bold">$${formatCurrencyArgentino(record.net_profit)}</td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewRecord(${record.id})" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${!record.is_withdrawn && !isFiltered() ? `
                            <button class="btn btn-outline-warning" 
                                    onclick="emptyRecord(${record.id}, '${record.date}', '${record.branch_name}')" 
                                    title="Retirar">
                                <i class="fas fa-hand-holding-usd"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    });
    
    // Una sola operaci√≥n DOM
    tableBody.innerHTML = html;
    
    updateRecordsCount(records.length);
    console.log('‚úÖ Tabla actualizada correctamente');
}

// Configurar sistema de filtros integrado
function setupIntegratedFilters() {
    console.log('üîß Configurando sistema de filtros integrado...');
    
    const filtersForm = document.getElementById('filtersForm');
    if (!filtersForm) return;
    
    // Preservar valores actuales en los campos
    preserveFilterValues();
    
    // Event listener para el formulario
    filtersForm.addEventListener('submit', function(e) {
        e.preventDefault();
        applyIntegratedFilters();
    });
    
    // Auto-filtrado para el selector de sucursal
    const branchSelect = document.querySelector('select[name="branch_filter"]');
    if (branchSelect) {
        branchSelect.addEventListener('change', function() {
            setTimeout(() => applyIntegratedFilters(), 300);
        });
    }
}


function hasTableColumn(tableId, columnText) {
    const headers = document.querySelectorAll(`${tableId} th`);
    return Array.from(headers).some(th => th.textContent.trim().includes(columnText));
}

// Aplicar filtros y recargar dashboard
function applyIntegratedFilters() {
    // ‚úÖ EVITAR M√öLTIPLES LLAMADAS CON DEBOUNCE
    if (filterTimeout) {
        clearTimeout(filterTimeout);
    }
    
    filterTimeout = setTimeout(() => {
        const formData = new FormData(document.getElementById('filtersForm'));
        
        const startDate = formData.get('start_date');
        const endDate = formData.get('end_date');
        const branchFilter = formData.get('branch_filter');
        
        // ‚úÖ VALIDAR FECHAS
        if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
            showToast('La fecha de inicio debe ser anterior a la fecha final', 'error');
            return;
        }
        
        // ‚úÖ ACTUALIZAR FILTROS
        currentFilters.start_date = startDate || null;
        currentFilters.end_date = endDate || null;
        currentFilters.branch_filter = branchFilter || null;
        
        console.log('üîÑ [OPTIMIZED] Aplicando filtros:', currentFilters);
        
        // ‚úÖ ACTUALIZAR URL
        updateURLWithFilters();
        
        // ‚úÖ RECARGAR DASHBOARD
        loadIntegratedDashboard();
    }, 300); // Esperar 300ms antes de ejecutar
}


function setupFilterEventListeners() {
    // Event listeners para inputs de fecha
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        input.addEventListener('change', function() {
            setTimeout(() => applyIntegratedFilters(), 300);
        });
    });
    
    // Event listener para bot√≥n de reset
    const resetButton = document.querySelector('.btn-outline-secondary');
    if (resetButton) {
        resetButton.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('filtersForm').reset();
            applyIntegratedFilters();
        });
    }
    
    // Auto-filtrado para el selector de sucursal
    const branchSelect = document.querySelector('select[name="branch_filter"]');
    if (branchSelect) {
        branchSelect.addEventListener('change', function() {
            setTimeout(() => applyIntegratedFilters(), 300);
        });
    }
}
// Funciones auxiliares
function updateURLWithFilters() {
    const params = new URLSearchParams();
    
    if (currentFilters.start_date) params.append('start_date', currentFilters.start_date);
    if (currentFilters.end_date) params.append('end_date', currentFilters.end_date);
    if (currentFilters.branch_filter) params.append('branch_filter', currentFilters.branch_filter);
    
    const newUrl = params.toString() ? 
        `${window.location.pathname}?${params.toString()}` : 
        window.location.pathname;
    
    window.history.replaceState({}, '', newUrl);
}

function preserveFilterValues() {
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    const branchSelect = document.querySelector('select[name="branch_filter"]');
    
    if (currentFilters.start_date && startDateInput) {
        startDateInput.value = currentFilters.start_date;
    }
    if (currentFilters.end_date && endDateInput) {
        endDateInput.value = currentFilters.end_date;
    }
    if (currentFilters.branch_filter && branchSelect) {
        branchSelect.value = currentFilters.branch_filter;
    }
}

function updateCardDescriptions() {
    const isFiltered = currentFilters.start_date || currentFilters.end_date || currentFilters.branch_filter;
    
    let description = 'En todas las sucursales';
    
    if (isFiltered) {
        if (currentFilters.branch_filter) {
            description = `En ${currentFilters.branch_filter}`;
        } else if (currentFilters.start_date || currentFilters.end_date) {
            description = 'Per√≠odo filtrado';
        } else {
            description = 'Con filtros aplicados';
        }
    }
    
    console.log('üìù Actualizando descripci√≥n de tarjetas:', description);
    
    // Actualizar descripci√≥n en las tarjetas
    document.querySelectorAll('.cash-tray-card small').forEach(el => {
        // Solo actualizar las descripciones que contienen info de ubicaci√≥n
        if (el.textContent.includes('todas las sucursales') || 
            el.textContent.includes('Con filtros') ||
            el.textContent.includes('En ') ||
            el.textContent.includes('Per√≠odo')) {
            el.textContent = description;
        }
    });
}

function updateFilterIndicators(filtersApplied) {
    // Mostrar indicador de filtros aplicados
    const existingIndicator = document.getElementById('filtersIndicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }
    
    if (filtersApplied.is_filtered) {
        const indicator = document.createElement('div');
        indicator.id = 'filtersIndicator';
        indicator.className = 'alert alert-info alert-sm mb-3';
        
        let filterText = 'Filtros aplicados: ';
        const filters = [];
        
        if (filtersApplied.start_date) {
            filters.push(`desde ${new Date(filtersApplied.start_date).toLocaleDateString('es-AR')}`);
        }
        if (filtersApplied.end_date) {
            filters.push(`hasta ${new Date(filtersApplied.end_date).toLocaleDateString('es-AR')}`);
        }
        if (filtersApplied.branch_filter) {
            filters.push(`sucursal ${filtersApplied.branch_filter}`);
        }
        
        filterText += filters.join(', ');
        
        indicator.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-filter me-2"></i>${filterText}</span>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllFilters()">
                    <i class="fas fa-times me-1"></i>Limpiar
                </button>
            </div>
        `;
        
        const filtersCard = document.querySelector('.filters-card');
        if (filtersCard) {
            filtersCard.insertAdjacentElement('afterend', indicator);
        }
    }
}

function isFiltered() {
    return !!(currentFilters.start_date || currentFilters.end_date || currentFilters.branch_filter);
}

function clearFilters() {
    console.log('üßπ Limpiando filtros...');
    
    // Limpiar campos del formulario
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    const branchSelect = document.querySelector('select[name="branch_filter"]');
    
    if (startDateInput) startDateInput.value = '';
    if (endDateInput) endDateInput.value = '';
    if (branchSelect) branchSelect.value = '';
    
    // Resetear filtros globales
    currentFilters = {
        start_date: null,
        end_date: null,
        branch_filter: null
    };
    
    // Actualizar URL sin par√°metros
    window.history.replaceState({}, '', window.location.pathname);
    
    // Recargar dashboard sin filtros
    loadIntegratedDashboard();
}

function clearAllFilters() {
    console.log('üßπ Limpiando TODOS los filtros...');
    clearFilters(); // Usa la funci√≥n principal
}

async function loadIntegratedDashboard() {
    // ‚úÖ VERIFICAR SI YA EST√Å CARGANDO
    if (isLoading) {
        console.log('üîÑ Carga ya en progreso, ignorando...');
        return;
    }
    
    // ‚úÖ MARCAR COMO CARGANDO
    isLoading = true;
    
    try {
        console.log('üöÄ [OPTIMIZED] Cargando dashboard optimizado...');
        showDashboardLoading();
        
        // ‚úÖ CONSTRUIR URL CON FILTROS
        const params = new URLSearchParams();
        if (currentFilters.start_date) params.append('start_date', currentFilters.start_date);
        if (currentFilters.end_date) params.append('end_date', currentFilters.end_date);
        if (currentFilters.branch_filter) params.append('branch_filter', currentFilters.branch_filter);
        
        const url = `{{ url_for('daily_records.api_integrated_dashboard') }}?${params.toString()}`;
        console.log('üåê Llamando a:', url);
        
        // ‚úÖ TIMEOUT DE SEGURIDAD MEJORADO
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.error('‚ùå Timeout: La operaci√≥n tard√≥ m√°s de 8 segundos');
        }, 8000);
        
        // ‚úÖ FETCH CON TIMEOUT
        const response = await fetch(url, {
            signal: controller.signal,
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        // ‚úÖ LIMPIAR TIMEOUT
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Datos recibidos:', data);
        
        if (data.status === 'success') {
            currentDashboardData = data.data;
            
            // ‚úÖ ACTUALIZACI√ìN OPTIMIZADA
            console.log(`‚ö° Datos recibidos en ${data.performance?.execution_time || 'N/A'}s`);
            
            // Usar requestAnimationFrame para suavizar la actualizaci√≥n
            requestAnimationFrame(() => {
                updateDineroDisponibleCards(data.data.totals);
                updateBranchTraysSection(data.data.branch_trays);
                updateRecordsTable(data.data.records);
                updateFilterIndicators(data.filters_applied);
            });
            
            console.log('‚úÖ Dashboard actualizado correctamente');
        } else {
            throw new Error(data.message || 'Error en la respuesta');
        }
        
    } catch (error) {
        if (error.name === 'AbortError') {
            console.error('‚ùå Operaci√≥n cancelada por timeout');
            showToast('La operaci√≥n tard√≥ demasiado tiempo. Intenta con filtros m√°s espec√≠ficos.', 'warning');
        } else {
            console.error('‚ùå Error cargando dashboard:', error);
            showDashboardError(error.message);
        }
    } finally {
        // ‚úÖ SIEMPRE RESETEAR EL ESTADO DE CARGA
        isLoading = false;
        hideDashboardLoading();
    }
}

// Funciones de operaciones de bandejas (mejoradas)
async function emptyBranchTray(branchName) {
    console.log(`üóëÔ∏è Intentando vaciar bandeja de: ${branchName}`);
    
    if (!currentDashboardData) {
        showToast('Error: No hay datos cargados', 'error');
        return;
    }
    
    // Buscar la bandeja en los datos actuales
    const tray = currentDashboardData.branch_trays.find(t => t.branch_name === branchName);
    if (!tray || tray.total_accumulated === 0) {
        showToast('No hay dinero en esa bandeja para vaciar', 'warning');
        return;
    }
    
    const totalAmount = formatCurrencyArgentino(tray.total_accumulated);
    
    if (!confirm(`¬øVaciar la bandeja de ${branchName}?\n\nTotal a retirar: $${totalAmount}`)) {
        return;
    }
    
    try {
        showDashboardLoading();
        
        // üîß CORRECCI√ìN: URL correcta con template Flask
        const response = await fetch(`{{ url_for('daily_records.empty_branch_tray', branch_name='PLACEHOLDER') }}`.replace('PLACEHOLDER', encodeURIComponent(branchName)), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        console.log(`üì° Respuesta vaciar bandeja: ${response.status}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('üì¶ Resultado:', result);
            
            showToast(`Bandeja de ${branchName} vaciada correctamente`, 'success');
            
            // ‚úÖ ACTUALIZAR TODO EL DASHBOARD INMEDIATAMENTE
            await loadIntegratedDashboard();
            
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('‚ùå Error response:', errorData);
            showToast(errorData.message || 'Error al vaciar la bandeja', 'error');
        }
    } catch (error) {
        console.error('‚ùå Error vaciando bandeja:', error);
        showToast('Error de conexi√≥n', 'error');
    } finally {
        hideDashboardLoading();
    }
}


async function emptyAllTrays() {
    console.log('üóëÔ∏è Intentando vaciar todas las bandejas');
    
    if (!currentDashboardData || currentDashboardData.totals.total === 0) {
        showToast('No hay dinero en las bandejas para vaciar', 'warning');
        return;
    }
    
    const totalAmount = formatCurrencyArgentino(currentDashboardData.totals.total);
    
    if (!confirm(`¬øEst√°s seguro de que deseas vaciar TODAS las bandejas?\n\nTotal a retirar: $${totalAmount}\n\nEsta acci√≥n no se puede deshacer.`)) {
        return;
    }
    
    try {
        showDashboardLoading();
        
        // üîß CORREGIR LA URL - usar la ruta correcta del Blueprint
        const response = await fetch('/daily-records/empty-all-trays', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        console.log(`üì° Respuesta vaciar todas: ${response.status}`);
        
        if (response.ok) {
            const result = await response.json();
            showToast('Todas las bandejas han sido vaciadas correctamente', 'success');
            
            // ‚úÖ ACTUALIZAR TODO EL DASHBOARD INMEDIATAMENTE
            await loadIntegratedDashboard();
            
        } else {
            const errorData = await response.json().catch(() => ({}));
            showToast(errorData.message || 'Error al vaciar las bandejas', 'error');
        }
    } catch (error) {
        console.error('‚ùå Error vaciando bandejas:', error);
        showToast('Error de conexi√≥n al vaciar las bandejas', 'error');
    } finally {
        hideDashboardLoading();
    }
}

async function recalculateTrays() {
    if (!confirm('¬øRecalcular todas las bandejas desde cero?\n\nEsto puede tardar unos segundos y corregir√° cualquier inconsistencia.')) {
        return;
    }
    
    try {
        showDashboardLoading();
        
        const response = await fetch('/daily-records/recalculate-trays', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast('Bandejas recalculadas correctamente', 'success');
            await loadIntegratedDashboard();
        } else {
            const errorData = await response.json().catch(() => ({}));
            showToast(errorData.message || 'Error al recalcular bandejas', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'error');
    } finally {
        hideDashboardLoading();
    }
}

// üîß FUNCI√ìN DE DEBUG para probar los endpoints:

window.testEmptyEndpoints = async function() {
    console.log('üß™ Probando endpoints de vaciar bandejas...');
    
    // Probar empty-all-trays
    try {
        const response1 = await fetch('/daily-records/empty-all-trays', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        console.log('‚úÖ Endpoint empty-all-trays responde:', response1.status);
    } catch (error) {
        console.log('‚ùå Error en empty-all-trays:', error);
    }
    
    // Probar empty-branch-tray (con una sucursal de ejemplo)
    if (currentDashboardData && currentDashboardData.branch_trays.length > 0) {
        const branchName = currentDashboardData.branch_trays[0].branch_name;
        try {
            const response2 = await fetch(`/daily-records/empty-branch-tray/${encodeURIComponent(branchName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            console.log(`‚úÖ Endpoint empty-branch-tray responde para ${branchName}:`, response2.status);
        } catch (error) {
            console.log(`‚ùå Error en empty-branch-tray para ${branchName}:`, error);
        }
    }
};

// üîß PARA DEBUG: Ejecuta esto en la consola para probar:
// window.testEmptyEndpoints();

async function emptyRecord(recordId, recordDate, branchName) {
    if (!confirm(`¬øRetirar el registro del ${recordDate} de la bandeja de ${branchName}?\n\nEsto restar√° ese d√≠a espec√≠fico del acumulado.`)) {
        return;
    }
    
    try {
        showDashboardLoading();
        
        const response = await fetch(`{{ url_for('daily_records.empty_record', record_id=0) }}`.replace('0', recordId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(`Registro del ${recordDate} retirado de la bandeja`, 'success');
            
            // ‚úÖ ACTUALIZAR TODO EL DASHBOARD INMEDIATAMENTE
            await loadIntegratedDashboard();
            
        } else {
            const errorData = await response.json().catch(() => ({}));
            showToast(errorData.message || 'Error al retirar el registro', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'error');
    } finally {
        hideDashboardLoading();
    }
}

// Funciones de loading y utilidades
function showDashboardLoading() {
    // ‚úÖ LIMPIAR TIMEOUT ANTERIOR
    if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
    }
    
    let overlay = document.getElementById('dashboardLoadingOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'dashboardLoadingOverlay';
        overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
        overlay.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        overlay.style.zIndex = '9999';
        overlay.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h5 class="text-primary">Cargando dashboard...</h5>
                <p class="text-muted">Esto puede tardar unos segundos</p>
                <div class="progress mt-3" style="width: 200px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }
    overlay.style.display = 'flex';
    
    // ‚úÖ TIMEOUT VISUAL CORREGIDO - MISMO TIEMPO QUE EL FETCH
    loadingTimeout = setTimeout(() => {
        const message = overlay.querySelector('p');
        if (message) {
            message.innerHTML = `
                <span class="text-warning">
                    <i class="fas fa-clock me-1"></i>
                    La operaci√≥n est√° tardando m√°s de lo esperado...
                </span>
            `;
        }
    }, 5000); // Reducido a 5 segundos
}


function hideDashboardLoading() {
    // ‚úÖ LIMPIAR TIMEOUT
    if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
    }
    
    const overlay = document.getElementById('dashboardLoadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
        overlay.remove();
    }
}

function showDashboardError(message) {
    // Mostrar error en todas las secciones principales
    const errorHtml = `
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5 class="text-danger">Error al cargar datos</h5>
            <p class="text-muted">${message}</p>
            <button class="btn btn-outline-primary" onclick="loadIntegratedDashboard()">
                <i class="fas fa-sync-alt me-2"></i>Reintentar
            </button>
        </div>
    `;
    
    // Error en dinero disponible
    const errorText = 'Error';
    const elements = [
        'totalCashTray', 'totalMercadoPagoTray', 
        'totalDebitoTray', 'totalCreditoTray', 'totalGeneralTray'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = errorText;
    });
    
    // Error en bandejas
    const container = document.getElementById('branchTraysContainer');
    if (container) container.innerHTML = errorHtml;
}

function formatCurrencyArgentino(amount) {
    const num = parseFloat(amount) || 0;
    return num.toLocaleString('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showDashboardError(message) {
    showToast(message || 'Error al cargar el dashboard', 'error');
    
    // ‚úÖ MOSTRAR BOT√ìN DE RETRY
    const errorHtml = `
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5 class="text-danger">Error al cargar datos</h5>
            <p class="text-muted">${message}</p>
            <button class="btn btn-outline-primary" onclick="loadIntegratedDashboard()">
                <i class="fas fa-redo me-1"></i> Reintentar
            </button>
        </div>
    `;
    
    // Mostrar error en secciones principales
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
        mainContent.innerHTML = errorHtml;
    }
}

function showToast(message, type = 'info') {
    // Remover toasts existentes
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '10000';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Auto-remove despu√©s de 5 segundos
    setTimeout(() => {
        if (toast && toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

console.log('‚úÖ Script de filtros optimizado cargado');

function viewRecord(id) {
    window.location.href = `/daily-records/view/${id}`;
}

// Funciones de filtros r√°pidos
function setQuickFilter(type) {
    const form = document.getElementById('filtersForm');
    const startDate = form.querySelector('input[name="start_date"]');
    const endDate = form.querySelector('input[name="end_date"]');
    
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    switch(type) {
        case 'today':
            startDate.value = todayStr;
            endDate.value = todayStr;
            break;
            
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            startDate.value = yesterdayStr;
            endDate.value = yesterdayStr;
            break;
            
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            startDate.value = weekStart.toISOString().split('T')[0];
            endDate.value = todayStr;
            break;
            
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            startDate.value = monthStart.toISOString().split('T')[0];
            endDate.value = todayStr;
            break;
    }
    
    // Aplicar filtros autom√°ticamente
    applyIntegratedFilters();
}

// Funci√≥n de refresh manual
function refreshTrays() {
    console.log('üîÑ Refresh manual solicitado');
    loadIntegratedDashboard();
}

// Mantener compatibilidad con funciones existentes
window.loadCashTrays = loadIntegratedDashboard;
window.emptyBranchTray = emptyBranchTray;
window.emptyAllTrays = emptyAllTrays;
window.emptyRecord = emptyRecord;
window.refreshTrays = refreshTrays;

// Funciones globales adicionales para compatibilidad
window.loadIntegratedDashboard = loadIntegratedDashboard;
window.applyIntegratedFilters = applyIntegratedFilters;
window.clearAllFilters = clearAllFilters;
window.setQuickFilter = setQuickFilter;
window.clearFilters = clearFilters;
window.updateDineroDisponibleCards = updateDineroDisponibleCards;
window.validateFilterData = validateFilterData;
window.getFilterType = getFilterType;
window.isFiltered = isFiltered;

function getFilterType() {
    const hasDateFilter = !!(currentFilters.start_date || currentFilters.end_date);
    const hasBranchFilter = !!currentFilters.branch_filter;
    
    if (hasBranchFilter && hasDateFilter) {
        return 'branch_and_date';
    } else if (hasBranchFilter) {
        return 'branch_only';
    } else if (hasDateFilter) {
        return 'date_only';
    } else {
        return 'none';
    }
}

// Funci√≥n para actualizar contador de registros
function updateRecordsCount(count) {
    const badge = document.getElementById('recordsCountBadge');
    if (badge) {
        badge.textContent = `${count} registro${count !== 1 ? 's' : ''}`;
        badge.className = count > 0 ? 'badge bg-primary ms-2' : 'badge bg-secondary ms-2';
    }
}

const originalUpdateRecordsTable = window.updateRecordsTable;
window.updateRecordsTable = function(records) {
    const result = originalUpdateRecordsTable(records);
    updateRecordsCount(records ? records.length : 0);
    return result;
};

// Compatibilidad con sistemas existentes
if (typeof window.loadCashTrays === 'undefined') {
    window.loadCashTrays = loadIntegratedDashboard;
}

// Debug helpers (solo en desarrollo)
window.debugDashboard = function() {
    console.log('üîç Estado actual del dashboard:');
    console.log('Filtros:', currentFilters);
    console.log('Datos:', currentDashboardData);
    console.log('¬øFiltrado?:', isFiltered());
};

// Debug helpers (solo en desarrollo)
window.debugDashboard = function() {
    console.log('üîç Estado actual del dashboard:');
    console.log('Filtros:', currentFilters);
    console.log('Datos:', currentDashboardData);
    console.log('¬øFiltrado?:', isFiltered());
};
</script>
{% endblock %}