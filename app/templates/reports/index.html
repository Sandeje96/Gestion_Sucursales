{# app/templates/reports/index.html #}
{% extends "layout/base.html" %}

{% block title %}
    Panel de Reportes - MundoLimp
{% endblock %}

{% block extra_css %}
<style>

    .card-body {
        padding: 2rem;
        background: white;
        color: black;
    }

    .mb-1 {
        margin-bottom: .25rem !important;
        color: black;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .metric-card {
        transition: transform 0.2s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .branch-comparison {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .period-selector {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
    }
    
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
    
    .trend-up { color: #10b981; }
    .trend-down { color: #ef4444; }
    .trend-neutral { color: #6b7280; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Panel de Reportes MundoLimp
                    </h1>
                    <p class="text-muted mb-0">
                        An√°lisis completo del rendimiento de todas las sucursales
                    </p>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                    
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Exportar
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.export_csv') }}">
                                    <i class="fas fa-file-csv me-2"></i>Reporte CSV
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i>Reporte PDF
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selector de per√≠odo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3" id="periodForm">
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Per√≠odo:</label>
                            <select name="period" class="form-select" onchange="updatePeriod()">
                                <option value="today" {{ 'selected' if request.args.get('period') == 'today' else '' }}>Hoy</option>
                                <option value="week" {{ 'selected' if request.args.get('period') == 'week' else '' }}>Esta Semana</option>
                                <option value="month" {{ 'selected' if request.args.get('period') == 'month' or not request.args.get('period') else '' }}>Este Mes</option>
                                <option value="quarter" {{ 'selected' if request.args.get('period') == 'quarter' else '' }}>Este Trimestre</option>
                                <option value="year" {{ 'selected' if request.args.get('period') == 'year' else '' }}>Este A√±o</option>
                                <option value="custom" {{ 'selected' if request.args.get('period') == 'custom' else '' }}>Personalizado</option>
                            </select>
                        </div>
                        
                        <!-- NUEVO: Filtro por sucursal -->
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Sucursal:</label>
                            <select name="branch_filter" class="form-select" onchange="updateBranchFilter()">
                                <option value="" {{ 'selected' if not request.args.get('branch_filter') else '' }}>Todas las sucursales</option>
                                <option value="Uruguay" {{ 'selected' if request.args.get('branch_filter') == 'Uruguay' else '' }}>Uruguay</option>
                                <option value="Villa Cabello" {{ 'selected' if request.args.get('branch_filter') == 'Villa Cabello' else '' }}>Villa Cabello</option>
                                <option value="Tacuari" {{ 'selected' if request.args.get('branch_filter') == 'Tacuari' else '' }}>Tacuari</option>
                                <option value="Candelaria" {{ 'selected' if request.args.get('branch_filter') == 'Candelaria' else '' }}>Candelaria</option>
                                <option value="Itaembe" {{ 'selected' if request.args.get('branch_filter') == 'Itaembe' else '' }}>Itaembe</option>
                                <option value="Garupa" {{ 'selected' if request.args.get('branch_filter') == 'Garupa' else '' }}>Garupa</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2" id="customDates" style="display: {{ 'block' if request.args.get('period') == 'custom' else 'none' }};">
                            <label class="form-label fw-semibold">Desde:</label>
                            <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                        </div>
                        
                        <div class="col-md-2" id="customDatesEnd" style="display: {{ 'block' if request.args.get('period') == 'custom' else 'none' }};">
                            <label class="form-label fw-semibold">Hasta:</label>
                            <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Filtrar
                            </button>
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="fas fa-times me-2"></i>Limpiar
                            </button>
                        </div>
                    </form>
                    
                    {% if current_period %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <!-- MEJORADO: Mostrar filtro aplicado -->
                            {% if request.args.get('branch_filter') %}
                                Sucursal: <strong>{{ request.args.get('branch_filter') }}</strong> | 
                            {% endif %}
                            Per√≠odo: 
                            <strong>{{ current_period.start.strftime('%d/%m/%Y') }} - {{ current_period.end.strftime('%d/%m/%Y') }}</strong>
                            {% if general_stats %}
                                ({{ general_stats.total_records }} registro{{ 's' if general_stats.total_records != 1 else '' }})
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if general_stats %}
    <!-- M√©tricas principales -->
    <div class="row mb-4">
    <!-- MEJORADO: Header con indicador de filtro -->
        {% if general_stats.is_filtered_by_branch %}
        <div class="col-12 mb-3">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-filter me-2"></i>
                <strong>Vista filtrada:</strong> Mostrando m√©tricas √∫nicamente de la sucursal 
                <strong class="ms-1">{{ general_stats.filtered_branch }}</strong>
                <a href="{{ url_for('reports.index', period=request.args.get('period', 'month'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}" 
                class="btn btn-sm btn-outline-primary ms-auto">
                    <i class="fas fa-times me-1"></i>Ver todas las sucursales
                </a>
            </div>
        </div>
        {% endif %}
        
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">
                                Ventas Totales
                                {% if general_stats.is_filtered_by_branch %}
                                    <small class="d-block opacity-50">{{ general_stats.filtered_branch }}</small>
                                {% endif %}
                            </h6>
                            <h3 class="mb-0">${{ "{:,.0f}".format(general_stats.total_sales).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                            <div class="trend-indicator">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span>
                                    {% if general_stats.is_filtered_by_branch %}
                                        {{ general_stats.total_records }} registro{{ 's' if general_stats.total_records != 1 else '' }}
                                    {% else %}
                                        +12,5% vs per√≠odo anterior
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cash-register fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">
                                Ganancia Neta
                                {% if general_stats.is_filtered_by_branch %}
                                    <small class="d-block opacity-50">{{ general_stats.filtered_branch }}</small>
                                {% endif %}
                            </h6>
                            <h3 class="mb-0">${{ "{:,.0f}".format(general_stats.net_profit).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                            <div class="trend-indicator">
                                <i class="fas fa-calculator me-1"></i>
                                <span>
                                    Gastos: ${{ "{:,.0f}".format(general_stats.total_expenses).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                </span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">
                                {% if general_stats.is_filtered_by_branch %}
                                    Promedio por Registro
                                {% else %}
                                    Sucursales Activas
                                {% endif %}
                            </h6>
                            <h3 class="mb-0">
                                {% if general_stats.is_filtered_by_branch %}
                                    ${{ "{:,.0f}".format(general_stats.total_sales / general_stats.total_records if general_stats.total_records > 0 else 0).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                {% else %}
                                    {{ general_stats.active_branches }}
                                {% endif %}
                            </h3>
                            <div class="trend-indicator">
                                <span>
                                    {% if general_stats.is_filtered_by_branch %}
                                        por registro diario
                                    {% else %}
                                        de 5 sucursales
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            {% if general_stats.is_filtered_by_branch %}
                                <i class="fas fa-calculator fa-2x opacity-50"></i>
                            {% else %}
                                <i class="fas fa-store fa-2x opacity-50"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">
                                Promedio Diario
                                {% if general_stats.is_filtered_by_branch %}
                                    <small class="d-block opacity-50">{{ general_stats.filtered_branch }}</small>
                                {% endif %}
                            </h6>
                            <h3 class="mb-0">${{ "{:,.0f}".format(general_stats.avg_daily_sales).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                            <div class="trend-indicator">
                                <span>
                                    {% if general_stats.is_filtered_by_branch %}
                                        en el per√≠odo
                                    {% else %}
                                        por sucursal
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-day fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos principales -->
    <div class="row mb-4">
        <!-- Tendencia de ventas diarias -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>Tendencia de Ventas (√öltimos 30 d√≠as)
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="updateSalesChart(7, this)">7D</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateSalesChart(15, this)">15D</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateSalesChart(30, this)">30D</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Distribuci√≥n de m√©todos de pago -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>M√©todos de Pago
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="paymentMethodsChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">M√°s usado</small>
                                <div class="fw-bold" id="topPaymentMethod">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">% del total</small>
                                <div class="fw-bold" id="topPaymentPercentage">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparativa por sucursales -->
    {% if branch_stats %}
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-building me-2"></i>Rendimiento por Sucursal
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="branchPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Estado sin datos -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay datos disponibles</h5>
                    <p class="text-muted">
                        No se encontraron registros para el per√≠odo seleccionado.<br>
                        Las sucursales deben cargar sus registros diarios para ver estad√≠sticas.
                    </p>
                    <a href="{{ url_for('daily_records.index') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Ver Registros
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para generar reporte personalizado -->
<div class="modal fade" id="generateReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Generar Reporte Personalizado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customReportForm">
                    <div class="mb-3">
                        <label class="form-label">Per√≠odo del reporte:</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" class="form-control" name="report_start" required>
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" name="report_end" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Sucursales a incluir:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="allBranches" checked>
                            <label class="form-check-label" for="allBranches">
                                Todas las sucursales
                            </label>
                        </div>
                        <div id="branchSelection" style="display: none;">
                            {% for branch in ['Uruguay', 'Villa Cabello', 'Tacuari', 'Candelaria', 'Itaembe', 'Garupa'] %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="branches" value="{{ branch }}" id="branch{{ loop.index }}">
                                <label class="form-check-label" for="branch{{ loop.index }}">
                                    {{ branch }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Formato de salida:</label>
                        <select class="form-select" name="format">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="submitCustomReport()">
                    <i class="fas fa-download me-2"></i>Generar Reporte
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns"></script>

<script>
// Variables globales para los gr√°ficos
let salesTrendChart, paymentMethodsChart, branchPerformanceChart;

// Funciones de formato argentino
function formatCurrencyArgentino(amount) {
    const num = parseFloat(amount) || 0;
    
    // Usar Intl.NumberFormat para formato argentino
    const formatted = new Intl.NumberFormat('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
    
    return `$${formatted}`;
}

function formatNumberArgentino(amount, decimals = 2) {
    const num = parseFloat(amount) || 0;
    
    return new Intl.NumberFormat('es-AR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num);
}

function formatPercentageArgentino(value, decimals = 1) {
    const num = parseFloat(value) || 0;
    
    return new Intl.NumberFormat('es-AR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num) + '%';
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Inicializando Dashboard de Reportes...');
    
    // Solo inicializar gr√°ficos si hay datos y elementos existen
    {% if general_stats %}
        // Verificar que los elementos canvas existan antes de inicializar
        if (document.getElementById('salesTrendChart')) {
            initializeSalesTrendChart();
        } else {
            console.warn('‚ö†Ô∏è Canvas salesTrendChart no encontrado');
        }
        
        if (document.getElementById('paymentMethodsChart')) {
            initializePaymentMethodsChart();
        } else {
            console.warn('‚ö†Ô∏è Canvas paymentMethodsChart no encontrado');
        }
        
        if (document.getElementById('branchPerformanceChart')) {
            initializeBranchPerformanceChart();
        } else {
            console.warn('‚ö†Ô∏è Canvas branchPerformanceChart no encontrado');
        }
        
        // Cargar datos solo si los gr√°ficos se inicializaron
        setTimeout(() => {
            loadDashboardData();
        }, 100);
        
        // Configurar actualizaciones autom√°ticas cada 5 minutos
        setInterval(refreshDashboard, 300000);
    {% else %}
        console.log('üì≠ No hay datos disponibles - omitiendo inicializaci√≥n de gr√°ficos');
    {% endif %}
});

function initializeSalesTrendChart() {
    try {
        const canvas = document.getElementById('salesTrendChart');
        if (!canvas) {
            console.error('‚ùå Canvas salesTrendChart no encontrado');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        salesTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Ventas',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Gastos',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Ganancia Neta',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrencyArgentino(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrencyArgentino(value);
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        console.log('‚úÖ Gr√°fico de tendencia de ventas inicializado');
    } catch (error) {
        console.error('‚ùå Error inicializando gr√°fico de ventas:', error);
    }
}

function updateBranchFilter() {
    const branchSelect = document.querySelector('select[name="branch_filter"]');
    if (!branchSelect) return;
    
    // Auto-submit cuando cambie la sucursal
    showLoadingAndSubmitReports();
}

function initializePaymentMethodsChart() {
    try {
        const canvas = document.getElementById('paymentMethodsChart');
        if (!canvas) {
            console.error('‚ùå Canvas paymentMethodsChart no encontrado');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        paymentMethodsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Efectivo', 'MercadoPago', 'D√©bito', 'Cr√©dito'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        '#10b981', // Verde para efectivo
                        '#3b82f6', // Azul para MercadoPago
                        '#f59e0b', // Amarillo para d√©bito
                        '#ef4444'  // Rojo para cr√©dito
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1).replace('.', ',') : 0;
                                return `${context.label}: ${formatCurrencyArgentino(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ Gr√°fico de m√©todos de pago inicializado');
    } catch (error) {
        console.error('‚ùå Error inicializando gr√°fico de m√©todos de pago:', error);
    }
}

// Funci√≥n que se ejecuta cuando se cambia el per√≠odo en el filtro
function handlePeriodChange() {
    const periodSelect = document.querySelector('select[name="period"]');
    if (!periodSelect) return;
    
    const customStart = document.getElementById('customStart');
    const customEnd = document.getElementById('customEnd');
    
    if (periodSelect.value === 'custom') {
        customStart.style.display = 'block';
        customEnd.style.display = 'block';
    } else {
        customStart.style.display = 'none';
        customEnd.style.display = 'none';
    }
}

// Funci√≥n para env√≠o inteligente de filtros con actualizaci√≥n de gr√°ficos
function showLoadingAndSubmitReports() {
    // Mostrar loading
    if (typeof showToast === 'function') {
        showToast('Actualizando reportes...', 'info');
    }
    
    // Enviar formulario para actualizar la p√°gina
    const form = document.querySelector('form');
    if (form) {
        form.submit();
    }
}

// Inicializaci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar estado de botones al cargar
    setTimeout(() => {
        updateButtonStates();
    }, 100);
    
    // Configurar event listener para cambio de per√≠odo
    const periodSelect = document.querySelector('select[name="period"]');
    if (periodSelect) {
        periodSelect.addEventListener('change', handlePeriodChange);
    }
    
    // Configurar auto-submit para filtro de sucursal
    const branchSelect = document.querySelector('select[name="branch_filter"]');
    if (branchSelect) {
        branchSelect.addEventListener('change', function() {
            showLoadingAndSubmitReports();
        });
    }
    
    // Configurar auto-submit para fechas personalizadas (con debounce)
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    
    if (startDateInput && endDateInput) {
        let timeout;
        
        function handleDateChange() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                if (startDateInput.value && endDateInput.value) {
                    showLoadingAndSubmitReports();
                }
            }, 500); // Esperar 500ms despu√©s del √∫ltimo cambio
        }
        
        startDateInput.addEventListener('change', handleDateChange);
        endDateInput.addEventListener('change', handleDateChange);
    }
});

function initializeBranchPerformanceChart() {
    try {
        const canvas = document.getElementById('branchPerformanceChart');
        if (!canvas) {
            console.error('‚ùå Canvas branchPerformanceChart no encontrado');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        branchPerformanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Ventas',
                        data: [],
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    },
                    {
                        label: 'Gastos',
                        data: [],
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrencyArgentino(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrencyArgentino(value);
                            }
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ Gr√°fico de rendimiento por sucursal inicializado');
    } catch (error) {
        console.error('‚ùå Error inicializando gr√°fico de rendimiento:', error);
    }
}

async function loadDashboardData() {
    console.log('üìä Cargando datos del dashboard...');
    
    try {
        // Solo cargar datos si hay gr√°ficos inicializados
        const promises = [];
        
        if (salesTrendChart) {
            // NUEVA L√ìGICA: Determinar qu√© datos cargar inicialmente
            const urlParams = new URLSearchParams(window.location.search);
            const startDate = urlParams.get('start_date');
            const endDate = urlParams.get('end_date');
            const currentPeriod = urlParams.get('period') || 'month';
            
            if (startDate && endDate && currentPeriod === 'custom') {
                // Si hay rango personalizado, usarlo
                promises.push(updateSalesChart(null)); // null indica usar rango personalizado
                console.log('üéØ Cargando gr√°fico con rango personalizado');
            } else {
                // Si no hay rango personalizado, usar 30 d√≠as por defecto
                promises.push(updateSalesChart(30));
                console.log('üéØ Cargando gr√°fico con 30 d√≠as por defecto');
            }
        }
        
        if (paymentMethodsChart) {
            promises.push(loadPaymentMethodsData());
        }
        
        if (branchPerformanceChart) {
            promises.push(loadBranchPerformanceData());
        }
        
        if (promises.length > 0) {
            await Promise.all(promises);
            console.log('üéâ Dashboard cargado completamente');
        } else {
            console.log('üì≠ No hay gr√°ficos para cargar datos');
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando datos del dashboard:', error);
        
        if (typeof showToast === 'function') {
            showToast('Error parcial cargando el dashboard', 'warning');
        }
    }
}

async function updateSalesChart(days, targetElement = null) {
    if (!salesTrendChart) {
        console.warn('‚ö†Ô∏è salesTrendChart no est√° inicializado');
        return;
    }
    
    try {
        // Obtener los par√°metros de filtro actuales de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentPeriod = urlParams.get('period') || 'month';
        const startDate = urlParams.get('start_date');
        const endDate = urlParams.get('end_date');
        const branchFilter = urlParams.get('branch_filter');
        
        // NUEVA L√ìGICA: Determinar si usar rango personalizado o botones
        let apiUrl;
        let chartTitle = 'Tendencia de Ventas';
        
        if (startDate && endDate && currentPeriod === 'custom') {
            // CASO 1: Hay rango personalizado - ignorar par√°metro days y usar el rango completo
            apiUrl = `{{ url_for('reports.api_daily_sales_chart') }}?start_date=${startDate}&end_date=${endDate}`;
            
            // Calcular d√≠as en el rango para el t√≠tulo
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            chartTitle = `Tendencia de Ventas (${daysDiff} d√≠as - ${formatDate(start)} a ${formatDate(end)})`;
            
            console.log('üìä Usando rango personalizado:', startDate, 'a', endDate, `(${daysDiff} d√≠as)`);
            
        } else {
            // CASO 2: No hay rango personalizado - usar botones (comportamiento original)
            apiUrl = `{{ url_for('reports.api_daily_sales_chart') }}?days=${days}`;
            chartTitle = `Tendencia de Ventas (√öltimos ${days} d√≠as)`;
            
            console.log('üìä Usando bot√≥n de d√≠as:', days);
        }
        
        // Agregar filtro de sucursal si existe
        if (branchFilter) {
            apiUrl += `&branch_filter=${encodeURIComponent(branchFilter)}`;
            chartTitle += ` - ${branchFilter}`;
        }
        
        console.log('üì° Llamando a API de ventas:', apiUrl);
        
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.status === 'success') {
            salesTrendChart.data = data.data;
            salesTrendChart.update();
            
            // Actualizar t√≠tulo del gr√°fico din√°micamente
            updateSalesChartTitle(chartTitle);
            
            // Actualizar botones activos SOLO si se proporciona targetElement (clicks de botones)
            if (targetElement && (!startDate || !endDate || currentPeriod !== 'custom')) {
                document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
                targetElement.classList.add('active');
            }
            
            console.log('‚úÖ Gr√°fico de ventas actualizado:', chartTitle);
        }
    } catch (error) {
        console.error('‚ùå Error actualizando gr√°fico de ventas:', error);
        if (typeof showToast === 'function') {
            showToast('Error actualizando gr√°fico de ventas', 'error');
        }
    }
}

function updateSalesChartTitle(title) {
    const salesChartTitle = document.querySelector('.card-header h6 .fa-chart-area').closest('h6');
    if (salesChartTitle) {
        salesChartTitle.innerHTML = `<i class="fas fa-chart-area me-2"></i>${title}`;
    }
}

function formatDate(date) {
    return date.toLocaleDateString('es-AR', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
    });
}

async function loadPaymentMethodsData() {
    if (!paymentMethodsChart) {
        console.warn('‚ö†Ô∏è paymentMethodsChart no est√° inicializado');
        return;
    }
    
    try {
        // Obtener par√°metros de filtro actuales
        const urlParams = new URLSearchParams(window.location.search);
        const startDate = urlParams.get('start_date');
        const endDate = urlParams.get('end_date');
        const branchFilter = urlParams.get('branch_filter');  // NUEVO: Obtener filtro de sucursal
        
        let apiUrl = '{{ url_for('reports.api_payment_distribution') }}?days=30';
        
        if (startDate && endDate) {
            apiUrl += `&start_date=${startDate}&end_date=${endDate}`;
        }
        
        // NUEVO: Agregar filtro de sucursal si existe
        if (branchFilter) {
            apiUrl += `&branch_filter=${encodeURIComponent(branchFilter)}`;
        }
        
        console.log('üì° Llamando a API de m√©todos de pago:', apiUrl);
        
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.status === 'success') {
            const chartData = data.data.chart_data;
            paymentMethodsChart.data.datasets[0].data = chartData.data;
            paymentMethodsChart.update();
            
            // Actualizar informaci√≥n adicional
            const amounts = data.data.amounts;
            const percentages = data.data.percentages;
            
            // Encontrar el m√©todo m√°s usado
            let maxIndex = 0;
            let maxValue = 0;
            chartData.data.forEach((value, index) => {
                if (value > maxValue) {
                    maxValue = value;
                    maxIndex = index;
                }
            });
            
            const topMethodElement = document.getElementById('topPaymentMethod');
            const topPercentageElement = document.getElementById('topPaymentPercentage');
            
            if (maxValue > 0 && topMethodElement && topPercentageElement) {
                topMethodElement.textContent = chartData.labels[maxIndex];
                const percentage = percentages[Object.keys(percentages)[maxIndex]];
                topPercentageElement.textContent = formatPercentageArgentino(percentage, 1);
            }
            
            console.log('‚úÖ Datos de m√©todos de pago actualizados con filtro:', branchFilter || 'Todas');
        }
    } catch (error) {
        console.error('‚ùå Error cargando datos de m√©todos de pago:', error);
    }
}

async function loadBranchPerformanceData() {
    if (!branchPerformanceChart) {
        console.warn('‚ö†Ô∏è branchPerformanceChart no est√° inicializado');
        return;
    }
    
    try {
        console.log('üîÑ Cargando datos de rendimiento por sucursal...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const period = urlParams.get('period') || 'month';
        const startDate = urlParams.get('start_date');
        const endDate = urlParams.get('end_date');
        const branchFilter = urlParams.get('branch_filter');  // NUEVO: Obtener filtro de sucursal
        
        // Construir URL con par√°metros
        let apiUrl = `{{ url_for('reports.api_branch_performance') }}?period=${period}`;
        if (startDate && endDate && period === 'custom') {
            apiUrl += `&start_date=${startDate}&end_date=${endDate}`;
        }
        
        // NUEVO: Agregar filtro de sucursal si existe
        if (branchFilter) {
            apiUrl += `&branch_filter=${encodeURIComponent(branchFilter)}`;
        }
        
        console.log('üì° Llamando a API de rendimiento:', apiUrl);
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Respuesta recibida:', data);
        
        if (data.status === 'success' && data.data) {
            branchPerformanceChart.data.labels = data.data.branches || [];
            branchPerformanceChart.data.datasets[0].data = data.data.sales || [];
            branchPerformanceChart.data.datasets[1].data = data.data.expenses || [];
            branchPerformanceChart.update();
            
            // Actualizar t√≠tulo del gr√°fico si hay filtro
            updateBranchPerformanceTitle(branchFilter);
            
            console.log('‚úÖ Gr√°fico de rendimiento actualizado con filtro:', branchFilter || 'Todas');
        } else {
            const errorMsg = data.message || 'Error desconocido del servidor';
            console.warn('‚ö†Ô∏è Error del servidor:', errorMsg);
            
            branchPerformanceChart.data.labels = [];
            branchPerformanceChart.data.datasets[0].data = [];
            branchPerformanceChart.data.datasets[1].data = [];
            branchPerformanceChart.update();
            
            if (typeof showToast === 'function') {
                showToast(`Sin datos de rendimiento: ${errorMsg}`, 'warning');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Error en loadBranchPerformanceData:', error);
        
        branchPerformanceChart.data.labels = [];
        branchPerformanceChart.data.datasets[0].data = [];
        branchPerformanceChart.data.datasets[1].data = [];
        branchPerformanceChart.update();
        
        if (typeof showToast === 'function') {
            showToast('Error cargando datos de rendimiento', 'error');
        }
    }
}

function updateChartTitles(branchFilter) {
    // Esta funci√≥n ahora se mantiene para compatibilidad pero el t√≠tulo de ventas 
    // se actualiza directamente en updateSalesChart para mayor precisi√≥n
    
    // Actualizar t√≠tulo del gr√°fico de m√©todos de pago
    const paymentChartTitle = document.querySelector('.card-header h6 .fa-credit-card').closest('h6');
    if (paymentChartTitle) {
        const baseTitle = 'M√©todos de Pago';
        if (branchFilter) {
            paymentChartTitle.innerHTML = `<i class="fas fa-credit-card me-2"></i>${baseTitle} - ${branchFilter}`;
        } else {
            paymentChartTitle.innerHTML = `<i class="fas fa-credit-card me-2"></i>${baseTitle}`;
        }
    }
}

// NUEVA FUNCI√ìN: Actualizar t√≠tulo del gr√°fico de rendimiento por sucursal
function updateBranchPerformanceTitle(branchFilter) {
    const performanceChartTitle = document.querySelector('.card-header h6 .fa-building').closest('h6');
    if (performanceChartTitle) {
        if (branchFilter) {
            performanceChartTitle.innerHTML = `<i class="fas fa-building me-2"></i>Rendimiento - ${branchFilter}`;
        } else {
            performanceChartTitle.innerHTML = `<i class="fas fa-building me-2"></i>Rendimiento por Sucursal`;
        }
    }
}

// Resto de funciones (updatePeriod, resetFilters, etc.)
function updatePeriod() {
    const periodSelect = document.querySelector('select[name="period"]');
    const customDates = document.getElementById('customDates');
    const customDatesEnd = document.getElementById('customDatesEnd');
    
    if (periodSelect && periodSelect.value === 'custom') {
        if (customDates) customDates.style.display = 'block';
        if (customDatesEnd) customDatesEnd.style.display = 'block';
    } else {
        if (customDates) customDates.style.display = 'none';
        if (customDatesEnd) customDatesEnd.style.display = 'none';
        // Auto-submit para per√≠odos predefinidos
        showLoadingAndSubmitReports();
    }
}

function resetFilters() {
    // Ir a la p√°gina sin filtros (per√≠odo por defecto: mes)
    window.location.href = '{{ url_for('reports.index') }}';
}

console.log('üéØ Filtro por sucursal agregado correctamente a los reportes');

function showLoadingAndSubmitReports() {
    const form = document.getElementById('periodForm');
    if (!form) return;
    
    const submitBtn = form.querySelector('button[type="submit"]');
    if (!submitBtn) return;
    
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cargando...';
    submitBtn.disabled = true;
    
    setTimeout(() => {
        form.submit();
    }, 100);
}

async function refreshDashboard() {
    const refreshBtn = document.querySelector('button[onclick="refreshDashboard()"]');
    if (!refreshBtn) return;
    
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
    refreshBtn.disabled = true;
    
    try {
        await loadDashboardData();
        if (typeof showToast === 'function') {
            showToast('Dashboard actualizado correctamente', 'success');
        }
    } catch (error) {
        if (typeof showToast === 'function') {
            showToast('Error actualizando el dashboard', 'error');
        }
    } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

// Funciones auxiliares
function generateReport() {
    // Configurar fechas por defecto
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    const startInput = document.querySelector('input[name="report_start"]');
    const endInput = document.querySelector('input[name="report_end"]');
    
    if (startInput) startInput.value = firstDayOfMonth.toISOString().split('T')[0];
    if (endInput) endInput.value = today.toISOString().split('T')[0];
    
    const modal = document.getElementById('generateReportModal');
    if (modal) {
        new bootstrap.Modal(modal).show();
    }
}

function submitCustomReport() {
    const form = document.getElementById('customReportForm');
    if (!form) return;
    
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Construir URL de descarga
    const params = new URLSearchParams();
    params.append('start_date', formData.get('report_start'));
    params.append('end_date', formData.get('report_end'));
    params.append('format', formData.get('format'));
    
    // Agregar sucursales seleccionadas
    const allBranchesCheck = document.getElementById('allBranches');
    if (!allBranchesCheck || !allBranchesCheck.checked) {
        const selectedBranches = formData.getAll('branches');
        selectedBranches.forEach(branch => params.append('branches', branch));
    }
    
    // Descargar reporte
    const downloadUrl = `{{ url_for('reports.export_csv') }}?${params.toString()}`;
    window.open(downloadUrl, '_blank');
    
    // Cerrar modal
    const modal = document.getElementById('generateReportModal');
    if (modal) {
        bootstrap.Modal.getInstance(modal).hide();
    }
    
    if (typeof showToast === 'function') {
        showToast('Descargando reporte personalizado...', 'info');
    }
}

function exportPDF() {
    if (typeof showToast === 'function') {
        showToast('Exportaci√≥n a PDF pr√≥ximamente disponible', 'info');
    } else {
        alert('Exportaci√≥n a PDF pr√≥ximamente disponible');
    }
}

// Funci√≥n auxiliar para mostrar notificaciones
function showToast(message, type = 'info') {
    // Esta funci√≥n debe estar definida en main.js
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
    } else {
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}

// Validaci√≥n de fechas personalizadas
document.addEventListener('DOMContentLoaded', function() {
    const startInput = document.querySelector('input[name="start_date"]');
    const endInput = document.querySelector('input[name="end_date"]');
    
    if (startInput && endInput) {
        startInput.addEventListener('change', function() {
            endInput.min = this.value;
            if (endInput.value && endInput.value < this.value) {
                endInput.value = this.value;
            }
        });
        
        endInput.addEventListener('change', function() {
            startInput.max = this.value;
            if (startInput.value && startInput.value > this.value) {
                startInput.value = this.value;
            }
        });
    }
    
    // Toggle de selecci√≥n de sucursales en modal
    const allBranchesCheck = document.getElementById('allBranches');
    const branchSelection = document.getElementById('branchSelection');
    
    if (allBranchesCheck && branchSelection) {
        allBranchesCheck.addEventListener('change', function() {
            branchSelection.style.display = this.checked ? 'none' : 'block';
            
            // Desmarcar todas las sucursales individuales si se selecciona "todas"
            if (this.checked) {
                document.querySelectorAll('input[name="branches"]').forEach(cb => cb.checked = false);
            }
        });
    }
});

// Auto-refresh de gr√°ficos cada 5 minutos (solo si hay datos)
{% if general_stats %}
setInterval(() => {
    loadDashboardData();
}, 300000);
{% endif %}

// Responsive charts - redimensionar cuando cambie el tama√±o de ventana
window.addEventListener('resize', function() {
    if (salesTrendChart) salesTrendChart.resize();
    if (paymentMethodsChart) paymentMethodsChart.resize();
    if (branchPerformanceChart) branchPerformanceChart.resize();
});

console.log('üìä Scripts de reportes cargados correctamente');
</script>
{% endblock %}