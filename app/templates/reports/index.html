{# app/templates/reports/index.html #}
{% extends "layout/base.html" %}

{% block title %}
    Panel de Reportes - MundoLimp
{% endblock %}

{% block extra_css %}
<style>

    .card-body {
        padding: 2rem;
        background: white;
        color: black;
    }

    .mb-1 {
        margin-bottom: .25rem !important;
        color: black;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .metric-card {
        transition: transform 0.2s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .branch-comparison {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .period-selector {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
    }
    
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
    
    .trend-up { color: #10b981; }
    .trend-down { color: #ef4444; }
    .trend-neutral { color: #6b7280; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Panel de Reportes MundoLimp
                    </h1>
                    <p class="text-muted mb-0">
                        Análisis completo del rendimiento de todas las sucursales
                    </p>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                    
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Exportar
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('reports.export_csv') }}">
                                    <i class="fas fa-file-csv me-2"></i>Reporte CSV
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="exportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i>Reporte PDF
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selector de período -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3" id="periodForm">
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Período:</label>
                            <select name="period" class="form-select" onchange="updatePeriod()">
                                <option value="today" {{ 'selected' if request.args.get('period') == 'today' else '' }}>Hoy</option>
                                <option value="week" {{ 'selected' if request.args.get('period') == 'week' else '' }}>Esta Semana</option>
                                <option value="month" {{ 'selected' if request.args.get('period') == 'month' else '' }}>Este Mes</option>
                                <option value="quarter" {{ 'selected' if request.args.get('period') == 'quarter' else '' }}>Este Trimestre</option>
                                <option value="year" {{ 'selected' if request.args.get('period') == 'year' else '' }}>Este Año</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3" id="customDates" style="display: none;">
                            <label class="form-label fw-semibold">Desde:</label>
                            <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                        </div>
                        
                        <div class="col-md-3" id="customDatesEnd" style="display: none;">
                            <label class="form-label fw-semibold">Hasta:</label>
                            <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Filtrar
                            </button>
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="fas fa-times me-2"></i>Limpiar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if general_stats %}
    <!-- Métricas principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">Ventas Totales</h6>
                            <h3 class="mb-0">${{ "%.0f"|format(general_stats.total_sales) }}</h3>
                            <div class="trend-indicator">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span>+12.5% vs período anterior</span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cash-register fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">Ganancia Neta</h6>
                            <h3 class="mb-0">${{ "%.0f"|format(general_stats.net_profit) }}</h3>
                            <div class="trend-indicator">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span>+8.3% vs período anterior</span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">Sucursales Activas</h6>
                            <h3 class="mb-0">{{ general_stats.active_branches }}</h3>
                            <div class="trend-indicator">
                                <span>de 5 sucursales</span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-store fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card metric-card bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title opacity-75">Promedio Diario</h6>
                            <h3 class="mb-0">${{ "%.0f"|format(general_stats.avg_daily_sales) }}</h3>
                            <div class="trend-indicator">
                                <span>por sucursal</span>
                            </div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-day fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos principales -->
    <div class="row mb-4">
        <!-- Tendencia de ventas diarias -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>Tendencia de Ventas (Últimos 30 días)
                    </h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="updateSalesChart(7)">7D</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateSalesChart(15)">15D</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateSalesChart(30)">30D</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Distribución de métodos de pago -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>Métodos de Pago
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="paymentMethodsChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">Más usado</small>
                                <div class="fw-bold" id="topPaymentMethod">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">% del total</small>
                                <div class="fw-bold" id="topPaymentPercentage">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparativa por sucursales -->
    {% if branch_stats %}
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-building me-2"></i>Rendimiento por Sucursal
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="branchPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Ranking de Sucursales
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for branch, stats in branch_stats.items() %}
                        {% set rank = loop.index %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge {{ 'bg-warning' if rank == 1 else 'bg-primary' if rank == 2 else 'bg-success' if rank == 3 else 'bg-secondary' }} me-2">
                                            {{ rank }}
                                        </span>
                                        <div>
                                            <h6 class="mb-0">{{ branch }}</h6>
                                            <small class="text-muted">
                                                {{ stats.records_count }} registro{{ 's' if stats.records_count != 1 else '' }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-success">${{ "%.0f"|format(stats.total_sales) }}</div>
                                    <small class="text-muted">
                                        Ganancia: ${{ "%.0f"|format(stats.net_profit) }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Accesos rápidos -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Accesos Rápidos
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{{ url_for('daily_records.index') }}" class="btn btn-outline-primary w-100 d-flex align-items-center">
                                <i class="fas fa-list me-2"></i>
                                <div class="text-start">
                                    <div>Ver Registros</div>
                                    <small class="opacity-75">Todos los registros</small>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-3">
                            <a href="{{ url_for('reports.comparison') }}" class="btn btn-outline-info w-100 d-flex align-items-center">
                                <i class="fas fa-balance-scale me-2"></i>
                                <div class="text-start">
                                    <div>Comparativas</div>
                                    <small class="opacity-75">Entre sucursales</small>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-3">
                            <button class="btn btn-outline-warning w-100 d-flex align-items-center" onclick="generateReport()">
                                <i class="fas fa-file-alt me-2"></i>
                                <div class="text-start">
                                    <div>Generar Reporte</div>
                                    <small class="opacity-75">Personalizado</small>
                                </div>
                            </button>
                        </div>
                        
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100 d-flex align-items-center" onclick="scheduleReport()">
                                <i class="fas fa-calendar-plus me-2"></i>
                                <div class="text-start">
                                    <div>Programar</div>
                                    <small class="opacity-75">Reporte automático</small>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Estado sin datos -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay datos disponibles</h5>
                    <p class="text-muted">
                        No se encontraron registros para el período seleccionado.<br>
                        Las sucursales deben cargar sus registros diarios para ver estadísticas.
                    </p>
                    <a href="{{ url_for('daily_records.index') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Ver Registros
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para generar reporte personalizado -->
<div class="modal fade" id="generateReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Generar Reporte Personalizado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customReportForm">
                    <div class="mb-3">
                        <label class="form-label">Período del reporte:</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" class="form-control" name="report_start" required>
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" name="report_end" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Sucursales a incluir:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="allBranches" checked>
                            <label class="form-check-label" for="allBranches">
                                Todas las sucursales
                            </label>
                        </div>
                        <div id="branchSelection" style="display: none;">
                            {% for branch in ['Uruguay', 'Villa Cabello', 'Tacuari', 'Candelaria', 'Itaembe Mini'] %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="branches" value="{{ branch }}" id="branch{{ loop.index }}">
                                <label class="form-check-label" for="branch{{ loop.index }}">
                                    {{ branch }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Formato de salida:</label>
                        <select class="form-select" name="format">
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="submitCustomReport()">
                    <i class="fas fa-download me-2"></i>Generar Reporte
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns"></script>

<script>
// Variables globales para los gráficos
let salesTrendChart, paymentMethodsChart, branchPerformanceChart;

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar gráficos
    initializeSalesTrendChart();
    initializePaymentMethodsChart();
    initializeBranchPerformanceChart();
    
    // Cargar datos iniciales
    loadDashboardData();
    
    // Configurar actualizaciones automáticas cada 5 minutos
    setInterval(refreshDashboard, 300000);
});

function initializeSalesTrendChart() {
    const ctx = document.getElementById('salesTrendChart').getContext('2d');
    salesTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Ventas',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.1,
                    fill: true
                },
                {
                    label: 'Gastos',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.1,
                    fill: true
                },
                {
                    label: 'Ganancia Neta',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

function initializePaymentMethodsChart() {
    const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
    paymentMethodsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Efectivo', 'MercadoPago', 'Débito', 'Crédito'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    '#10b981', // Verde para efectivo
                    '#3b82f6', // Azul para MercadoPago
                    '#f59e0b', // Amarillo para débito
                    '#ef4444'  // Rojo para crédito
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function initializeBranchPerformanceChart() {
    const ctx = document.getElementById('branchPerformanceChart').getContext('2d');
    branchPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Ventas',
                    data: [],
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 1
                },
                {
                    label: 'Gastos',
                    data: [],
                    backgroundColor: '#ef4444',
                    borderColor: '#dc2626',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

async function loadDashboardData() {
    try {
        // Cargar datos de tendencia de ventas
        await updateSalesChart(30);
        
        // Cargar datos de métodos de pago
        await loadPaymentMethodsData();
        
        // Cargar datos de rendimiento por sucursal
        await loadBranchPerformanceData();
        
    } catch (error) {
        console.error('Error cargando datos del dashboard:', error);
        showToast('Error cargando datos del dashboard', 'error');
    }
}

async function updateSalesChart(days) {
    try {
        const response = await fetch(`{{ url_for('reports.api_daily_sales_chart') }}?days=${days}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            salesTrendChart.data = data.data;
            salesTrendChart.update();
            
            // Actualizar botones activos
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
    } catch (error) {
        console.error('Error actualizando gráfico de ventas:', error);
    }
}

async function loadPaymentMethodsData() {
    try {
        const response = await fetch('{{ url_for('reports.api_payment_distribution') }}?days=30');
        const data = await response.json();
        
        if (data.status === 'success') {
            const chartData = data.data.chart_data;
            paymentMethodsChart.data.datasets[0].data = chartData.data;
            paymentMethodsChart.update();
            
            // Actualizar información adicional
            const amounts = data.data.amounts;
            const percentages = data.data.percentages;
            
            // Encontrar el método más usado
            let maxIndex = 0;
            let maxValue = 0;
            chartData.data.forEach((value, index) => {
                if (value > maxValue) {
                    maxValue = value;
                    maxIndex = index;
                }
            });
            
            if (maxValue > 0) {
                document.getElementById('topPaymentMethod').textContent = chartData.labels[maxIndex];
                document.getElementById('topPaymentPercentage').textContent = percentages[Object.keys(percentages)[maxIndex]] + '%';
            }
        }
    } catch (error) {
        console.error('Error cargando datos de métodos de pago:', error);
    }
}

async function loadBranchPerformanceData() {
    try {
        const response = await fetch('{{ url_for('reports.api_branch_performance') }}?period=month');
        const data = await response.json();
        
        if (data.status === 'success') {
            branchPerformanceChart.data.labels = data.data.branches;
            branchPerformanceChart.data.datasets[0].data = data.data.sales;
            branchPerformanceChart.data.datasets[1].data = data.data.expenses;
            branchPerformanceChart.update();
        }
    } catch (error) {
        console.error('Error cargando datos de rendimiento por sucursal:', error);
    }
}

function updatePeriod() {
    const periodSelect = document.querySelector('select[name="period"]');
    const customDates = document.getElementById('customDates');
    const customDatesEnd = document.getElementById('customDatesEnd');
    
    if (periodSelect.value === 'custom') {
        customDates.style.display = 'block';
        customDatesEnd.style.display = 'block';
    } else {
        customDates.style.display = 'none';
        customDatesEnd.style.display = 'none';
        // Auto-submit para períodos predefinidos
        document.getElementById('periodForm').submit();
    }
}

function resetFilters() {
    const form = document.getElementById('periodForm');
    form.reset();
    window.location.href = '{{ url_for('reports.index') }}';
}

async function refreshDashboard() {
    const refreshBtn = document.querySelector('button[onclick="refreshDashboard()"]');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
    refreshBtn.disabled = true;
    
    try {
        await loadDashboardData();
        showToast('Dashboard actualizado correctamente', 'success');
    } catch (error) {
        showToast('Error actualizando el dashboard', 'error');
    } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

function generateReport() {
    // Configurar fechas por defecto
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    document.querySelector('input[name="report_start"]').value = firstDayOfMonth.toISOString().split('T')[0];
    document.querySelector('input[name="report_end"]').value = today.toISOString().split('T')[0];
    
    new bootstrap.Modal(document.getElementById('generateReportModal')).show();
}

function submitCustomReport() {
    const form = document.getElementById('customReportForm');
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Construir URL de descarga
    const params = new URLSearchParams();
    params.append('start_date', formData.get('report_start'));
    params.append('end_date', formData.get('report_end'));
    params.append('format', formData.get('format'));
    
    // Agregar sucursales seleccionadas
    if (!document.getElementById('allBranches').checked) {
        const selectedBranches = formData.getAll('branches');
        selectedBranches.forEach(branch => params.append('branches', branch));
    }
    
    // Descargar reporte
    const downloadUrl = `{{ url_for('reports.export_csv') }}?${params.toString()}`;
    window.open(downloadUrl, '_blank');
    
    // Cerrar modal
    bootstrap.Modal.getInstance(document.getElementById('generateReportModal')).hide();
    
    showToast('Descargando reporte personalizado...', 'info');
}

function scheduleReport() {
    showToast('Función de programación de reportes próximamente disponible', 'info');
}

function exportPDF() {
    showToast('Exportación a PDF próximamente disponible', 'info');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Toggle de selección de sucursales
    const allBranchesCheck = document.getElementById('allBranches');
    const branchSelection = document.getElementById('branchSelection');
    
    if (allBranchesCheck) {
        allBranchesCheck.addEventListener('change', function() {
            branchSelection.style.display = this.checked ? 'none' : 'block';
            
            // Desmarcar todas las sucursales individuales si se selecciona "todas"
            if (this.checked) {
                document.querySelectorAll('input[name="branches"]').forEach(cb => cb.checked = false);
            }
        });
    }
    
    // Validación de fechas en el modal
    const startDateInput = document.querySelector('input[name="report_start"]');
    const endDateInput = document.querySelector('input[name="report_end"]');
    
    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', function() {
            endDateInput.min = this.value;
        });
        
        endDateInput.addEventListener('change', function() {
            startDateInput.max = this.value;
        });
    }
});

// Función auxiliar para mostrar notificaciones
function showToast(message, type = 'info') {
    // Esta función debe estar definida en main.js
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
    } else {
        alert(message);
    }
}

// Auto-refresh de gráficos cada 5 minutos
setInterval(() => {
    loadDashboardData();
}, 300000);

// Responsive charts - redimensionar cuando cambie el tamaño de ventana
window.addEventListener('resize', function() {
    if (salesTrendChart) salesTrendChart.resize();
    if (paymentMethodsChart) paymentMethodsChart.resize();
    if (branchPerformanceChart) branchPerformanceChart.resize();
});
</script>
{% endblock %}