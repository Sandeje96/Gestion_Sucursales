{# app/templates/main/branch_dashboard.html #}
{% extends "layout/base.html" %}

{% block title %}
    Panel de Sucursal - {{ current_user.branch_name }} | Sistema de Control de Sucursales
{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .trend-indicator {
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        margin-top: 0.25rem;
    }
    
    .chart-container {
        height: 250px;
        position: relative;
    }
    
    .status-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .quick-action-btn {
        border-radius: 12px;
        padding: 1rem;
        text-decoration: none;
        display: block;
        transition: all 0.2s ease;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-2px);
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header personalizado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1">
                                <i class="fas fa-store me-2"></i>
                                Bienvenido, {{ current_user.username }}
                            </h2>
                            <h4 class="mb-2 opacity-90">Sucursal: {{ current_user.branch_name }}</h4>
                            <p class="mb-0 opacity-75">
                                <i class="fas fa-calendar me-2"></i>
                                {{ moment().format('dddd, DD [de] MMMM [de] YYYY') if moment else "Hoy" }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <div class="me-3">
                                    <div class="text-center">
                                        <div class="h1 mb-0">{{ moment().format('HH:mm') if moment else "" }}</div>
                                        <small class="opacity-75">Hora actual</small>
                                    </div>
                                </div>
                                <div class="metric-icon bg-white bg-opacity-20">
                                    <i class="fas fa-clock text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if stats and stats.today_record %}
                <div class="status-badge bg-success text-white">
                    <i class="fas fa-check-circle me-1"></i>Registro de hoy completado
                </div>
                {% else %}
                <div class="status-badge bg-warning text-dark">
                    <i class="fas fa-exclamation-triangle me-1"></i>Registro pendiente
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# Flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row mb-4">
                <div class="col-12">
                    {% for category, message in messages %}
                        {% set alert_class = 'success' if category == 'success' else 'danger' if category == 'error' else 'warning' if category == 'warning' else 'info' %}
                        <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-triangle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    {% if stats %}
    <!-- Métricas principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-success bg-opacity-10 text-success me-3">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Ventas del Mes</h6>
                            <h3 class="mb-0 text-success">${{ "%.2f"|format(stats.monthly.total_sales) }}</h3>
                            <div class="trend-indicator text-success">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span>+5.2% vs mes anterior</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Ganancia Neta</h6>
                            <h3 class="mb-0 {{ 'text-success' if stats.monthly.net_amount >= 0 else 'text-danger' }}">
                                ${{ "%.2f"|format(stats.monthly.net_amount) }}
                            </h3>
                            <div class="trend-indicator {{ 'text-success' if stats.monthly.net_amount >= 0 else 'text-danger' }}">
                                <i class="fas {{ 'fa-arrow-up' if stats.monthly.net_amount >= 0 else 'fa-arrow-down' }} me-1"></i>
                                <span>Gastos: ${{ "%.2f"|format(stats.monthly.total_expenses) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-info bg-opacity-10 text-info me-3">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Registros del Mes</h6>
                            <h3 class="mb-0 text-info">{{ stats.monthly.records_count }}</h3>
                            <div class="trend-indicator text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                <span>{{ ((stats.monthly.records_count / moment().day) * 100)|round|int if moment else 0 }}% del mes</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card dashboard-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-warning bg-opacity-10 text-warning me-3">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Gastos del Mes</h6>
                            <h3 class="mb-0 text-warning">${{ "%.2f"|format(stats.monthly.total_expenses) }}</h3>
                            <div class="trend-indicator text-muted">
                                <i class="fas fa-percent me-1"></i>
                                <span>{{ ((stats.monthly.total_expenses / stats.monthly.total_sales * 100) if stats.monthly.total_sales > 0 else 0)|round|int }}% de ventas</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado del registro de hoy -->
    <div class="row mb-4">
        <div class="col-md-8">
            {% if stats.today_record %}
            <div class="card dashboard-card bg-light-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-success text-white me-3">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-1 text-success">¡Registro de hoy completado!</h5>
                            <p class="mb-0 text-muted">
                                Ya has cargado el registro del día de hoy. 
                                Ventas: <strong>${{ "%.2f"|format(stats.today_record.total_sales) }}</strong>, 
                                Gastos: <strong>${{ "%.2f"|format(stats.today_record.total_expenses) }}</strong>
                            </p>
                        </div>
                        <div>
                            <a href="{{ url_for('daily_records.edit', id=stats.today_record.id) }}" 
                               class="btn btn-outline-success">
                                <i class="fas fa-edit me-2"></i>Editar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card dashboard-card bg-light-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-warning text-white me-3">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-1 text-warning">Pendiente: Registro del día</h5>
                            <p class="mb-0 text-muted">
                                Aún no has cargado el registro diario de hoy. 
                                Recuerda registrar las ventas y gastos del día.
                            </p>
                        </div>
                        <div>
                            <a href="{{ url_for('daily_records.create') }}" 
                               class="btn btn-warning">
                                <i class="fas fa-plus me-2"></i>Cargar Ahora
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-4">
            <div class="card dashboard-card h-100">
                <div class="card-body text-center">
                    <div class="metric-icon bg-info bg-opacity-10 text-info mx-auto mb-3">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <h6 class="mb-2">Consejo del día</h6>
                    <p class="small text-muted mb-0">
                        {% set tips = [
                            "Registra tus ventas al final del día para no olvidar ningún detalle.",
                            "Revisa que todos los métodos de pago sumen correctamente.",
                            "Guarda los comprobantes de gastos para futuras consultas.",
                            "Compara tus ventas con días anteriores para detectar tendencias.",
                            "Mantén un registro detallado de gastos extraordinarios."
                        ] %}
                        {{ tips[range(0, tips|length)|random] }}
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráfico de tendencias -->
    {% if stats and stats.weekly_records %}
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card dashboard-card">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>Tendencia de Ventas (Últimos 7 días)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weeklyTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card dashboard-card h-100">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Mejores Días
                    </h6>
                </div>
                <div class="card-body">
                    {% set sorted_records = stats.weekly_records|sort(attribute='total_sales', reverse=true) %}
                    {% for record in sorted_records[:3] %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="fw-bold">{{ record.record_date.strftime('%d/%m') }}</div>
                            <small class="text-muted">{{ record.record_date.strftime('%A') }}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-success">${{ "%.0f"|format(record.total_sales) }}</div>
                            <small class="text-muted">
                                {% if loop.index == 1 %}🥇{% elif loop.index == 2 %}🥈{% else %}🥉{% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Acciones rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{{ url_for('daily_records.create') }}" 
                               class="quick-action-btn btn btn-primary h-100 d-flex align-items-center">
                                <div class="text-center w-100">
                                    <i class="fas fa-plus fa-2x mb-2"></i>
                                    <div class="fw-bold">Cargar Nuevo Registro Diario</div>
                                    <small class="opacity-75">Ingresa las ventas y gastos del día. Es importante mantener actualizada la información diaria.</small>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-3">
                            <a href="{{ url_for('daily_records.index') }}" 
                               class="quick-action-btn btn btn-outline-info h-100 d-flex align-items-center">
                                <div class="text-center w-100">
                                    <i class="fas fa-history fa-2x mb-2"></i>
                                    <div class="fw-bold">Ver Historial de Registros</div>
                                    <small class="opacity-75">Consulta todos los registros anteriores de tu sucursal y analiza tendencias de ventas.</small>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-3">
                            <a href="{{ url_for('daily_records.stats') }}" 
                               class="quick-action-btn btn btn-outline-success h-100 d-flex align-items-center">
                                <div class="text-center w-100">
                                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                    <div class="fw-bold">Ver Estadísticas</div>
                                    <small class="opacity-75">Analiza el rendimiento de tu sucursal con gráficos detallados.</small>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-3">
                            <a href="{{ url_for('auth.profile') }}" 
                               class="quick-action-btn btn btn-outline-secondary h-100 d-flex align-items-center">
                                <div class="text-center w-100">
                                    <i class="fas fa-user-cog fa-2x mb-2"></i>
                                    <div class="fw-bold">Mi Perfil</div>
                                    <small class="opacity-75">Gestiona tu cuenta y configuración personal.</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if stats and stats.recent_records %}
    <!-- Registros recientes -->
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-2"></i>Registros Recientes
                    </h6>
                    <a href="{{ url_for('daily_records.index') }}" class="btn btn-sm btn-outline-primary">
                        Ver todos los registros
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Ventas</th>
                                    <th>Gastos</th>
                                    <th>Ganancia</th>
                                    <th>Estado</th>
                                    <th width="100">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in stats.recent_records %}
                                <tr>
                                    <td>
                                        <strong>{{ record.record_date.strftime('%d/%m/%Y') }}</strong>
                                        <br><small class="text-muted">{{ record.record_date.strftime('%A') }}</small>
                                    </td>
                                    <td>
                                        <strong class="text-success">${{ "%.2f"|format(record.total_sales) }}</strong>
                                    </td>
                                    <td>
                                        <span class="text-danger">${{ "%.2f"|format(record.total_expenses) }}</span>
                                    </td>
                                    <td>
                                        {% set net = record.total_sales - record.total_expenses %}
                                        <strong class="{{ 'text-success' if net >= 0 else 'text-danger' }}">
                                            ${{ "%.2f"|format(net) }}
                                        </strong>
                                    </td>
                                    <td>
                                        {% if record.is_verified %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Verificado
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock me-1"></i>Pendiente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('daily_records.view', id=record.id) }}" 
                                               class="btn btn-outline-primary" 
                                               data-bs-toggle="tooltip" 
                                               title="Ver">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('daily_records.edit', id=record.id) }}" 
                                               class="btn btn-outline-warning"
                                               data-bs-toggle="tooltip" 
                                               title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Estado sin registros -->
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Aún no tienes registros</h5>
                    <p class="text-muted mb-4">
                        Comienza cargando tu primer registro diario para ver estadísticas y análisis de tu sucursal.
                    </p>
                    <a href="{{ url_for('daily_records.create') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Cargar mi primer registro
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Inicializar gráfico de tendencias semanales
    {% if stats and stats.weekly_records %}
    initializeWeeklyTrendChart();
    {% endif %}
    
    // Actualizar reloj cada minuto
    updateClock();
    setInterval(updateClock, 60000);
    
    // Animaciones de entrada para las tarjetas
    animateCards();
});

{% if stats and stats.weekly_records %}
function initializeWeeklyTrendChart() {
    const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
    
    // Preparar datos
    const weeklyData = {{ stats.weekly_records | tojson }};
    const labels = weeklyData.map(record => {
        const date = new Date(record.record_date);
        return date.toLocaleDateString('es-AR', { weekday: 'short', day: 'numeric' });
    });
    
    const salesData = weeklyData.map(record => parseFloat(record.total_sales));
    const expensesData = weeklyData.map(record => parseFloat(record.total_expenses));
    const netData = weeklyData.map((record, index) => salesData[index] - expensesData[index]);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Ventas',
                    data: salesData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                },
                {
                    label: 'Gastos',
                    data: expensesData,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#ef4444',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                },
                {
                    label: 'Ganancia Neta',
                    data: netData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: false,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            elements: {
                point: {
                    hoverRadius: 8
                }
            }
        }
    });
}
{% endif %}

function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('es-AR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const clockElement = document.querySelector('.h1');
    if (clockElement && clockElement.textContent !== timeString) {
        clockElement.textContent = timeString;
    }
}

function animateCards() {
    // Intersection Observer para animar las tarjetas cuando entran en vista
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1
    });

    // Aplicar animación a las tarjetas del dashboard
    document.querySelectorAll('.dashboard-card').forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
}

// Función para mostrar notificaciones de recordatorio
function showDailyReminder() {
    const now = new Date();
    const currentHour = now.getHours();
    
    // Mostrar recordatorio al final del día si no hay registro
    {% if not (stats and stats.today_record) %}
    if (currentHour >= 18 && currentHour <= 22) {
        setTimeout(() => {
            if (typeof showToast === 'function') {
                showToast(
                    'Recordatorio: No olvides cargar el registro diario antes de cerrar.',
                    'warning'
                );
            }
        }, 5000);
    }
    {% endif %}
}

// Ejecutar recordatorio
showDailyReminder();

// Función para exportar datos de la sucursal
function exportBranchData() {
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    const startDate = firstDayOfMonth.toISOString().split('T')[0];
    const endDate = today.toISOString().split('T')[0];
    
    const exportUrl = `{{ url_for('reports.export_csv') }}?start_date=${startDate}&end_date=${endDate}&branch={{ current_user.branch_name }}`;
    window.open(exportUrl, '_blank');
}

// Función para obtener estadísticas en tiempo real
async function refreshStats() {
    try {
        const response = await fetch('{{ url_for('main.api_branch_stats') }}');
        const data = await response.json();
        
        if (data.status === 'success') {
            // Actualizar métricas sin recargar la página
            const stats = data.data;
            
            // Actualizar ventas del mes
            const monthlySalesEl = document.querySelector('.text-success h3');
            if (monthlySalesEl) {
                monthlySalesEl.textContent = ' + stats.monthly.total_sales.toFixed(2);
            }
            
            // Mostrar notificación de actualización
            if (typeof showToast === 'function') {
                showToast('Estadísticas actualizadas', 'success');
            }
        }
    } catch (error) {
        console.error('Error actualizando estadísticas:', error);
    }
}

// Auto-refresh cada 10 minutos
setInterval(refreshStats, 600000);

// Función para predicciones simples
function calculateProjections() {
    {% if stats and stats.monthly.records_count > 0 %}
    const currentDayOfMonth = new Date().getDate();
    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
    
    const avgDailySales = {{ stats.monthly.total_sales }} / {{ stats.monthly.records_count }};
    const remainingDays = daysInMonth - currentDayOfMonth;
    const projectedMonthlyTotal = {{ stats.monthly.total_sales }} + (avgDailySales * remainingDays);
    
    // Mostrar proyección en consola (se puede implementar en la UI)
    console.log(`Proyección del mes: ${projectedMonthlyTotal.toFixed(2)}`);
    {% endif %}
}

// Calcular proyecciones al cargar
calculateProjections();

// Manejo de errores globales para el dashboard
window.addEventListener('error', function(e) {
    console.error('Error en dashboard:', e.error);
});

// Función para mostrar sugerencias basadas en datos
function showInsights() {
    {% if stats and stats.monthly.records_count > 0 %}
    const avgSales = {{ stats.monthly.total_sales }} / {{ stats.monthly.records_count }};
    const expenseRatio = ({{ stats.monthly.total_expenses }} / {{ stats.monthly.total_sales }}) * 100;
    
    let insights = [];
    
    if (expenseRatio > 30) {
        insights.push('Los gastos representan más del 30% de las ventas. Considera revisar los costos operativos.');
    }
    
    if (avgSales < 1000) {
        insights.push('El promedio de ventas diarias está por debajo de $1000. Evalúa estrategias para incrementar las ventas.');
    }
    
    if ({{ stats.monthly.net_amount }} < 0) {
        insights.push('La sucursal está operando con pérdidas este mes. Es importante analizar las causas.');
    }
    
    // Mostrar insights en consola (se puede implementar modal o sección dedicada)
    if (insights.length > 0) {
        console.log('Insights para {{ current_user.branch_name }}:', insights);
    }
    {% endif %}
}

// Generar insights
setTimeout(showInsights, 3000);

// Funciones de utilidad para el dashboard
const DashboardUtils = {
    formatCurrency: function(amount) {
        return new Intl.NumberFormat('es-AR', {
            style: 'currency',
            currency: 'ARS'
        }).format(amount);
    },
    
    formatPercentage: function(value) {
        return (value * 100).toFixed(1) + '%';
    },
    
    getDateRange: function(days) {
        const end = new Date();
        const start = new Date();
        start.setDate(start.getDate() - days);
        return { start, end };
    },
    
    animateNumber: function(element, finalValue, duration = 1000) {
        const startValue = 0;
        const startTime = performance.now();
        
        function updateValue(currentTime) {
            const elapsedTime = currentTime - startTime;
            const progress = Math.min(elapsedTime / duration, 1);
            const currentValue = startValue + (finalValue - startValue) * progress;
            
            element.textContent = DashboardUtils.formatCurrency(currentValue);
            
            if (progress < 1) {
                requestAnimationFrame(updateValue);
            }
        }
        
        requestAnimationFrame(updateValue);
    }
};

// Animar números al cargar
document.querySelectorAll('h3').forEach(el => {
    const text = el.textContent;
    const match = text.match(/\$?([\d,]+\.?\d*)/);
    if (match) {
        const value = parseFloat(match[1].replace(',', ''));
        if (!isNaN(value)) {
            el.textContent = '$0.00';
            setTimeout(() => {
                DashboardUtils.animateNumber(el, value);
            }, 500);
        }
    }
});
</script>
{% endblock %}